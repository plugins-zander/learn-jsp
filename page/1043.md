# MVC

​    MVC模式的核心思想是有效地组合“视图”、“模型”和“控制器”。
   本章将介绍MVC模式，掌握该模式对于设计合理的Web应用以及学习使用某些流行的Web框架，如Hibernate，Spring，Struts等，都有着十分重要的意义。



## MVC模式介绍 

​    MVC是一种通过三个不同部分构造一个软件或组件的理想办法：
模型（Model）——用于存储数据的对象。
视图（View）——为模型提供数据显示的对象。
控制器（Controller）——负责具体的业务逻辑操作，即控制器根据视图提出的要求对数据做出处理，并将有关结果存储到模型中，同时负责让模型和视图进行必要的交互，当模型中的数据变化时，让视图更新显示。

## JSP中的MVC模式 

​    在JSP技术中，“视图”、“模型”和“控制器”的具体实现如下： 
模型（Model）：
   一个或多个JavaBean对象，用于存储数据，JavaBean主要提供简单的setXXX()方法和getXXX()方法，在这些方法中不涉及对数据的具体处理细节。
视图（View）：
​    一个或多个JSP页面，为模型提供数据显示，JSP页面主要使用 HTML标记和JavaBean标记来显示数据。
控制器（Controller）：
​    一个或多个Servlet对象，根据视图提交的要求进行数据处理操作，并将有关的结果存储到JavaBean中，然后Servlet使用重定向方式请求视图中的某个JSP页面更新显示.

![image](https://img1.zlogs.net/20/20200615200919.png)





## 模型的生命周期与视图更新

​      在JSP+Javabean模式中，由JSP页面通过使用useBean标记：
`<jsp:useBean id="名字" class="创建bean的类" scope="生命周期"/>`创建Javabean。

​    JSP中的MVC模式中，也可以由控制器servet创建Javabean，并将有关数据存储到所创建的Javabean中，然后servlet请求某个JSP页面使用Javabean的getProperty动作标记：
`<jsp:getProperty name= "名字" property="bean的属性"/>`
显示Javabean的中的数据。 

​    在JSP中的MVC模式中，非常重要的手段是由servlet负责用构造方法创建Javabean，因此允许创建Javabean的类可以有带参数的构造方法。

​     在JSP中的MVC模式中，servet创建的Javabean也涉及到生命周期(有效期限)，生命周期分为request、session和application。以下假设创建Javabean的类的名字是BeanClass，该类的包名为user.yourbean 。



### request周期的Javabean 

#### Javabean的创建

   servlet负责创建bean。那么创建生命周期为request的bean的步骤如下：
（1）用BeanClass类的某个构造方法创建bean对象，例如：
         `BeanClass bean=new BeanClass();`
（2）将所创建的bean对象存放到HttpSerletRequest对象request中，并指定查找该bean的关键字，该步骤决定了bean的生命周期为request。例如：
        `request.setAttribute("keyWord",bean);`
执行上述操作，就会把bean存放到Tomcat引擎管理的内置对象pageContext中，该bean被指定的id是"keyWord"，生命周期是   
       `PageContext.REQUEST_SCOPE（request）`。

#### 视图更新

​    servlet请求一个JSP页面，比如show.jsp的代码如下：
`RequestDispatcher dispatcher= request.getRequestDispatcher("show.jsp");
dispatcher.forward(request,response);`

​    servlet所请求的JSP页面可以使用如下标记获得servlet所创建的bean的引用（type属性使得该JSP页面不负责创建bean）：
`<jsp:useBean id="keyWord" type="user.yourbean.BeanClass" scope="request"/>`
该标记中的id是servlet所创建的bean索引关键字。然后JSP页面使用`<jsp:getProperty name="keyWord" property="bean的变量"/>`标记显示bean中的数据。如果上述代码执行成功，用户就看到了show.jsp页面的执行效果。
​    特别注意: 如果servlet所请求的JSP页面,使用如下标记获得servlet所创建的bean的引用(注意没有用type属性而是用class属性)：
  `<jsp:useBean id="keyWord" class="user.yourbean.BeanClass" scope="request"/>`
该标记中的id是servlet所创建的bean索引关键字。那么即使servlet所请求的JSP页面事先已经有了id是"keyWord"，scope是"request"的bean，那么这个bean也会被servlet所创建的bean替换。
​     原因是servlet所请求的JSP页面会被刷新，就会根据当前页面使用的`<jsp:useBean id="keyWord" class="user.yourbean.BeanClass" scope="request"/>` 标记到Tomcat引擎管理的内置对象PageContext中寻找id是"keyWord"，生命周期是request，而该bean已经被servlet更新了。

###  session周期的Javabean 

#### Javabean的创建

   servet创建生命周期为session的bean的步骤如下：
（1）用BeanClass类的某个构造方法创建bean对象，例如：
   ` BeanClass bean=new BeanClass();`
（2）将所创建的bean对象存放到HttpSerletSession对象：session中，并指定查找该bean的关键字，该步骤决定了bean的生命周期为session。例如：
     `HttpSession session=request.getSession(true);
     session.setAttribute("keyWord",bean);`
   内置对象执行上述操作，就会把bean存放到Tomcat引擎管理的内置对象pageContext中，该bean被指定的id是"keyWord"，生命周期是`PageContext.SESSION_SCOPE（session）`。

#### 视图更新 

​    servelt创建bean,bean的生命周期为session，只要用户的session没有消失，该bean就一直存在，一个用户在访问Web服务目录的各个JSP中都可以使用<jsp:useBean id="keyWord" type="usern.yourbean.BeanClass" scope="session"/> 标记获得servlet所创建的bean的引用，然后使用<jsp:getProperty name="keyWord" property="bean的变量"/>标记显示该bean中的数据，该标记中的id是servlet所创建的bean索引关键字。
​    对于生命周期为session的bean，如果servlet希望某个JSP显示其中的数据，可以使用RequestDispatcher对象向该JSP页面发出请求，也可以使用HttpServletResponse类中的重定向方法（sendRedirect）。
​    show.jsp页面使用如下标记获得servlet所创建的bean的引用(注意没有用type属性而是用class属性)：<jsp:useBean id="keyWord" class="user.yourbean.BeanClass" scope="session"/>该标记中的id是servlet所创建的bean索引关键字。那么即使servlet所请求的JSP页面或其他页面事先已经有了id是"keyWord"，scope是" session "的bean，那么这个bean也会被servlet所创建的bean替换。
​     原因是，servlet所请求的JSP页面或其他页面被刷新时，就会根据当前页面使用的<jsp:useBean id="keyWord" class="user.yourbean.BeanClass" scope=" session "/>标记到Tomcat引擎管理的内置对象PageContext中寻找id是"keyWord"，生命周期是session,而该bean已经被servlet更新了。



### application周期的Javabean 

####    Javabean的创建 

​    servet创建生命周期为application的bean的步骤如下：
（1）用BeanClass类的某个构造方法创建bean对象，例如：
​         BeanClass bean=new BeanClass();
（2）servlet使用getServletContext()方法返回服务器的ServletContext内置对象的引用，将所创建的bean对象存放到服务器这个ServletContext内置对象中，并指定查找该bean的关键字，该步骤决定了bean的生命周期为application，例如：
​      getServletContext().setAttribute("keyWord",bean);
上述操作，就会把bean存放到Tomcat引擎管理的内置对象pageContext中，该bean被指定的id是"keyWord"，有效期限是（生命周期）PageContext.APPLICATION_SCOPE（application）。

#### 视图更新

​    当servlet创建创建生命周期为application的bean后，只要Web应用程序不结束，该bean就一直存在。一个用户在访问Web服务目录的各个JSP中都可以使用`<jsp:useBean id="keyWord" type="user.yourbean.BeanClass" scope="application"/>`  标记获得servlet所创建的bean的引用，然后使用
`<jsp:getProperty name="keyWord" property="bean的变量"/>`标记显示该Javabean中的数据，该标记中的id是servlet所创建的bean索引关键字。
​    对于生命周期为application的bean，如果servlet希望某个JSP显示其中的数据，可以使用RequestDispatcher对象向该JSP页面发出请求，也可以使用HttpServletResponse类中的重定向方法（sendRedirect）。
​    注意:所有用户在同一个Web服务目录中的application生命周期的bean是相同的，即占有相同的内存空间。另外,如果servlet所请求的JSP页面，比如show.jsp页面，使用如下标记获得servlet所创建的bean的引用(注意没有用type属性而是用class属性)：`<jsp:useBean id="keyWord" class="user.yourbean.BeanClass" scope="application"/>`该标记中的id是servlet所创建的bean索引关键字。那么即使servlet所请求的JSP页面或其他事先已经有了id是"keyWord"，scope是"application"的bean，那么这个bean也会被servlet所创建的bean替换。
   原因是，servlet所请求的JSP页面或其他页面被刷新时，就会根据当前页面使用的：`<jsp:useBean id="keyWord" class="user.yourbean.BeanClass" scope="application"/>`标记到Tomcat引擎管理的内置对象PageContext中寻找id是"keyWord"，生命周期是application，而该bean已经被servlet更新了。





> MVC模式的简单实例 

>    本节结合一个简单的实例体现MVC三个部分的设计与实现。   
>        计算三角形和 梯形的面积 

> Javabean和Servlet与配置文件 

>    按着本章的约定Javabean类的包名均为mybean.data；Servlet类的包名均为myservlet.control。 
> 1．保存Javabean类和Servlet类的源文件 
>     D:\ mybean\data  和  D:\myservlet\control
> 2．编译Javabean类 
>     D:> javac mybean\data\Javabean的源文件 
> 3．编译Servlet类 
>     D:> javac myservlet\control\servlet的源文件 
> 4．将类的字节码文件保存到服务器 
>      ch9\WEB-INF\classes\mybean\data 
>      和ch9\WEB-INF\classes\myservlet\control 
> 5．web.xml文件 
>    编写web.xml文件，并保存到Web服务目录的WEB-INF子目录中，即ch9\WEB-INF中 。

> 计算三角形和梯形的面积 

>    设计一个Web应用，该Web应用提供两个JSP页面，一个页面使得用户可以输入三角形三边的值和梯形的上底、下底和高的值；另一个页面可以显示三角形和梯形的面积。Web应用提供一个名字为computerArea的servlet对象，computerArea负责计算三角形和梯形的面积（computerArea由HandleArea类负责创建，访问它的url-pattern为lookArea，见前面的web.xml中的配置），然后将有关数据存储到Javabean中。Web应用提供的Javabean负责存储数据结果，该Javabean提供简单的获取数据和修改数据的方法。 

> 1．模型（Javabean） 

> Area.java 

>    本模型Area.java中的getXxx和setXxx方法不涉及对数据的具体处理细节，以便增强模型的通用性。 

```java
package mybean.data;
public class Area{
   double a,b,c,area; 
   String mess;
   public void setMess(String mess){
      this.mess=mess;
   }
   public String getMess(){
      return mess;
   } 
   public void setA(double a){
      this.a=a;
   }
   public void setB(double b){
      this.b=b;
   }
   public void setC(double c){
      this.c=c;
   }
   public void setArea(double s){
      area=s;
   }
   public double getArea(){
      return area;
   }
}

```





> 2．控制器（servlet） 

> HandleArea .java
>     控制器是名字为computerArea的servlet对象（见web.xml中的配置），由下面的Servlet类负责创建。控制器使用doPost方法计算三角形的面积；使用doGet方法计算梯形的面积 。

```java
package myservlet.control;
import mybean.data.Area;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class HandleArea extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response) 
                        throws ServletException,IOException{
      Area dataBean=new Area();              //创建Javabean对象
      request.setAttribute("data",dataBean);//将dataBean存储到request对象中
      try{  double a=Double.parseDouble(request.getParameter("a"));
            double b=Double.parseDouble(request.getParameter("b"));
            double c=Double.parseDouble(request.getParameter("c"));
            dataBean.setA(a);            //将数据存储在dataBean中 
            dataBean.setB(b);            
            dataBean.setC(c); 
            double s=-1;
            double p=(a+b+c)/2.0;
            if(a+b>c&&a+c>b&&b+c>a)
              s=Math.sqrt(p*(p-a)*(p-b)*(p-c));
            dataBean.setArea(s);         //将数据存储在dataBean中
            dataBean.setMess("三角形面积");  
      }
      catch(Exception e){
            dataBean.setArea(-1);
            dataBean.setMess(""+e);  
      }
      RequestDispatcher dispatcher=request.getRequestDispatcher("showResult.jsp");
       //请求showResult.jsp显示dataBean中的数据:
       dispatcher.forward(request,response);  
    } 
   public void doGet(HttpServletRequest request,HttpServletResponse response) 
                        throws ServletException,IOException{
      Area dataBean=new Area();             //创建Javabean对象
      request.setAttribute("data",dataBean);//将dataBean存储到request对象中
      try{  double a=Double.parseDouble(request.getParameter("a"));
            double b=Double.parseDouble(request.getParameter("b"));
            double c=Double.parseDouble(request.getParameter("c"));
            dataBean.setA(a);            //将数据存储在dataBean中 
            dataBean.setB(b);            
            dataBean.setC(c); 
            double s=-1;
            s=(a+b)*c/2.0;
            dataBean.setArea(s);         //将数据存储在dataBean中 
            dataBean.setMess("梯形面积");   
      }
      catch(Exception e){
            dataBean.setArea(-1);
            dataBean.setMess(""+e);  
      }
      RequestDispatcher dispatcher=request.getRequestDispatcher("showResult.jsp");
      //请求showResult.jsp显示dataBean中的数据 :
      dispatcher.forward(request,response);  
  }
}


```





> 3．视图（JSP页面） 

>    在inputData.jsp页面可以输入三角形三边的值或梯形的上、下底和高的值，并将所输入的三角形三边的值和梯形的上、下底和高的值分别用post方法和get方法提交给名字为computerArea的servlet对象。computerArea使用doPost方法计算三角形的面积；使用doGet方法计算梯形的面积，并将结果存储到数据模型bean中，然后请求showResult.jsp页面显示模型中的数据。
>   inputData.jsp（效果如图9-3）  
>   showResult.jsp（效果如图9-4） 

![image](https://img1.zlogs.net/20/20200615202217.png)

```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<HTML><BODY bgcolor=cyan><Font size=2>
<FORM action="lookArea" Method="post" >
   三角形：
  <BR>输入边A:<Input type=text name="a" size=4>
      输入边B:<Input type=text name="b" size=4>
      输入边C:<Input type=text name="c" size=4>
  <Input type=submit value="提交">
</FORM>
<FORM action="lookArea" Method="get" >
   梯形：
  <BR>输入上底:<Input type=text name="a" size=4>
      输入下底:<Input type=text name="b" size=4>
      输入高:  <Input type=text name="c" size=4>
  <Input type=submit value="提交">
</FORM>
</Font></BODY></HTML>
```

```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<%@ page import="mybean.data.Area"%> 
<jsp:useBean id="data" type="mybean.data.Area" scope="request"/>
<HTML><BODY bgcolor=yellow>
   <jsp:getProperty name="data" property="mess"/>:
   <jsp:getProperty name="data" property="area"/>
</BODY></HTML>

```









## MVC模式与注册登录 

​    大部分Web应用都会涉及到注册与登录模块。本节使用MVC模式讲述怎样设计注册、登录模块。为ch9\WEB-INF中的web.xml文件添加如下子标记 



> Javabean与Servlet管理 

> 本节的Javabean类的包名均为mybean.data；Servlet类的包名均为myservlet.control。
>
> 1．保存Javabean类和Servlet类的源文件 
>    D:\ mybean\data 和 D:\myservlet\control
> 2．编译Javabean类 
>      D:> javac mybean\data\Javabean的源文件 
> 3．编译Servlet类 
>       D:> javac myservlet\control\servlet的源文件 
> 4．将类的字节码文件保存到服务器 
>      ch9\WEB-INF\classes\mybean\data   和
>      ch9\WEB-INF\classes\myservlet\control



> 配置文件管理 

>    本节的Servlet类的包名均为myservlet.control，需要配置Web服务目录的web.xml文件，即将下面的web.xml文件保存到Tomcat安装目录的Web服务目录ch9中。根据本书使用的Tomcat安装目录及Web服务目录，需要将web.xml文件保存到D:\apache-tomcat-8.0.3\webapps\ch9\WEB-INF目录中。

web.xml 

```xml
<servlet>
    <servlet-name>register</servlet-name>
    <servlet-class>myservlet.control.HandleRegister</servlet-class>
</servlet>
<servlet-mapping>
   <servlet-name>register</servlet-name>
   <url-pattern>/helpRegister</url-pattern>
</servlet-mapping>
<servlet>
    <servlet-name>login</servlet-name>
    <servlet-class>myservlet.control.HandleLogin</servlet-class>
</servlet>
<servlet-mapping>
   <servlet-name>login</servlet-name>
   <url-pattern>/helpLogin</url-pattern>
</servlet-mapping>

```

> 数据库设计与连接 

>    使用MySQL建立一个数据库student，该库共有一个user表 。
>
> ​    user表的用途：存储用户的注册信息。即会员的注册信息存入user表中，user表的主键是logname，各个字段值的说明如下：
> logname ：存储注册的用户名（属性是字符型，主键）。
> password ：存储密码（属性是字符型）。
> email ：存储email（属性是字符型）。

> ​    避免操作数据库出现中文乱码，需要使用
> ​      Connection getConnection(java.lang.String) 方法建立连接，连接中的代码是（用户是root，其密码是空）：
>
> ```java
>  String uri = "jdbc:mysql://127.0.0.1/student?"+
>              "user=root&password=&characterEncoding=gb2312";
> Connection con = DriverManager.getConnection(uri);
> ```

> 注册

> ​    当新会员注册时，该模块要求用户必须输入会员名、密码信息，否则不允许注册。用户的注册信息被存入数据库的user表中。 
> ​    该模块视图部分由一个JSP页面构成，这个JSP页面register.jsp负责提交用户的注册信息到servlet控制器register（见配置文件web.xml），并负责显示注册是否成功的信息。该模块的Javabean模型userBean存储用户的注册信息。servlet控制器register负责将视图提交的信息写入数据库的user表中，并将有关反馈信息存储到Javabean模型userBean中，然后将用户转发到register.jsp，register.jsp将显示Javabean模型userBean中的数据（更新视图）,效果如图9-6所示。 

> 1．视图（JSP页面） 
>       register .jsp
> 2．模型（Javabean） 
>    Register .java 
> 3．控制器（servlet）
>   HandleRegister .java 

![image](https://img1.zlogs.net/20/20200615202953.png)



```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<jsp:useBean id="userBean" class="mybean.data.Register" scope="request"/>
<title>注册页面</title>
<HTML><BODY bgcolor=yellow><Font size=2>
<div align="center">
<FORM action="helpRegister" method="post" name=form>
<table>
    用户名由字母、数字、下划线构成，*注释的项必须填写。
   <tr><td>*用户名称:</td><td><Input type=text name="logname" ></td>
       <td>*用户密码:</td><td><Input type=password name="password">
       </td></tr>
   <tr><td>*重复密码:</td><td>
       <Input type=password name="again_password"></td>
       <td>email:</td><td><Input type=text name="email"></td></tr>
       <tr><td><Input type=submit name="g" value="提交"></td> </tr>
</table>
</Form>
</div>
<div align="center">
<p> 注册反馈：
<jsp:getProperty name="userBean"  property="backNews" /> 
<table border=3>
     <tr><td>会员名称:</td>
     <td><jsp:getProperty name="userBean" property="logname"/></td>
     </tr>
     <tr><td>email地址:</td>
     <td><jsp:getProperty name="userBean" property="email"/></td>
     </tr>
</table></div >
</Body></HTML>

```

```java
package mybean.data;
public class Register{  
   String  logname="" , email="",
           backNews="请填注册信息"; 
   public void setLogname(String logname){  
      this.logname=logname;
   }
   public String getLogname(){  
      return logname;
   }
   public void setEmail(String email){  
      this.email=email;
   }
   public String getEmail(){  
      return email;
   }
   public void setBackNews(String backNews){  
      this.backNews=backNews;
   }
   public String getBackNews(){  
      return backNews;
   }
}

```

```java
package myservlet.control;
import mybean.data.*;
import java.sql.*;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class HandleRegister extends HttpServlet {
   public void init(ServletConfig config) throws ServletException { 
      super.init(config);
      try {  Class.forName("com.mysql.jdbc.Driver");
      }
      catch(Exception e){} 
   }
   public String handleString(String s)
   {   try{ byte bb[]=s.getBytes("iso-8859-1");
            s=new String(bb);
       }
       catch(Exception ee){} 
       return s;  
   }
   public  void  doPost(HttpServletRequest request,HttpServletResponse response) 
                        throws ServletException,IOException {
      String uri="jdbc:mysql://127.0.0.1/student?"+
                             "user=root&password=&characterEncoding=gb2312";
      Connection con; 
      PreparedStatement sql; 
      Register userBean=new Register();  //创建的Javabean模型
      request.setAttribute("userBean",userBean);//将会更新id是"userBean"的bean
      String logname=request.getParameter("logname").trim();
      String password=request.getParameter("password").trim();
      String again_password=request.getParameter("again_password").trim();
      String email=request.getParameter("email").trim();
      if(logname==null)
           logname="";
      if(password==null)
           password="";
      if(!password.equals(again_password)) { 
         userBean.setBackNews("两次密码不同，注册失败，");
         RequestDispatcher dispatcher= 
         request.getRequestDispatcher("register.jsp");
         dispatcher.forward(request, response);//转发
         return;
      }
      boolean isLD=true;
      for(int i=0;i<logname.length();i++){
          char c=logname.charAt(i);
           if(!((c<='z'&&c>='a')||(c<='Z'&&c>='A')||(c<='9'&&c>='0'))) 
             isLD=false;
      } 
      boolean boo=logname.length()>0&&password.length()>0&&isLD;
      String backNews="";
      try{   con=DriverManager.getConnection(uri);
             String insertCondition="INSERT INTO user VALUES (?,?,?)";
             sql=con.prepareStatement(insertCondition);
             if(boo)
             { sql.setString(1,handleString(logname));
               sql.setString(2,handleString(password));
               sql.setString(3,handleString(email));
               int m=sql.executeUpdate();
               if(m!=0){
                  backNews="注册成功";
                  userBean.setBackNews(backNews);
                  userBean.setLogname(logname);
                  userBean.setEmail(handleString(email));
               }
             }
             else {
                 backNews="信息填写不完整或名字中有非法字符";
                 userBean.setBackNews(backNews);  
             }
             con.close();
      }
      catch(SQLException exp){
             backNews="该会员名已被使用，请您更换名字"+exp;
             userBean.setBackNews(backNews); 
      }
      RequestDispatcher dispatcher= 
      request.getRequestDispatcher("register.jsp");
      dispatcher.forward(request, response);//转发
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
                        throws ServletException,IOException {
      doPost(request,response);
   }
}

```







> 登录与验证 

> ​    用户可在该模块输入自己的会员名和密码,系统将对会员名和密码进行验证,如果输入用户名或密码有错误,将提示用户输入的用户名或密码不正确。
> ​    该模块视图部分由2个JSP页面longin.jsp和lookPic.jsp构成，longin.jsp页面负责提交用户的登录信息到控制器，并显示登录是否成功的信息，登录成功后lookPic.jsp页面负责显示一幅图像，如果没有登录，用户访问lookPic.jsp页面会被转发到longin.jsp登录页面。该模块的Javabean模型loginBean存储用户登录的信息。该模块的servlet控制器login负责验证会员名和密码是否正确，并负责更新视图。

> 1．视图（JSP页面） 
>       login.jsp
> 2．模型（Javabean） 
>    Login.java 
> 3．控制器（servlet）
>      HandleLogin.java 
> 4．验证 
>    lookPic.jsp 

![image](https://img1.zlogs.net/20/20200615203058.png)

```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<jsp:useBean id="loginBean" class="mybean.data.Login" scope="session"/>
<HTML><BODY bgcolor=cyan><font size=2>
<div align="center">
<table border=2>
<tr> <th>登录</th></tr>
<FORM action="helpLogin" Method="post">
<tr><td>登录名称:<Input type=text name="logname"></td></tr>
<tr><td>输入密码:<Input type=password name="password"></td></tr>
</table>
<Input type=submit name="g" value="提交">
</form>
<a href = "lookPic.jsp?logname=<jsp:getProperty name="loginBean"
                                property="logname"/>">
   登录后看图片</a>
</div >
<div align="center" >
登录反馈信息:<br>
<jsp:getProperty name="loginBean" property="backNews"/>
<br>登录名称:<br><jsp:getProperty name="loginBean" property="logname"/>
<div ></font>
</BODY></HTML>

```

```java
package mybean.data;
public class Login {
   String logname="",
          backNews="未登录";   
   public void setLogname(String logname){  
      this.logname=logname;
   }
   public String getLogname(){
        return logname;
   }
   public void setBackNews(String s) {
       backNews=s;
   } 
   public String getBackNews() {
      return backNews;
   }
}

```

```java
package myservlet.control;
import mybean.data.*;
import java.sql.*;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class HandleLogin extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
      try{ 
           Class.forName("com.mysql.jdbc.Driver");
      }
      catch(Exception e){} 
   }
   public String handleString(String s){
      try{  byte bb[]=s.getBytes("iso-8859-1");
            s=new String(bb);
      }
      catch(Exception ee){} 
      return s;  
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response) 
                        throws ServletException,IOException{
      Connection con; 
      Statement sql; 
      String logname=request.getParameter("logname").trim(),
      password=request.getParameter("password").trim();
      logname=handleString(logname);
      password=handleString(password);
      String uri="jdbc:mysql://127.0.0.1/student?"+
                             "user=root&password=&characterEncoding=gb2312";
      boolean boo=(logname.length()>0)&&(password.length()>0);  
      try{ 
           con=DriverManager.getConnection(uri);
           String condition="select * from user where logname = '"+logname+
            "' and password ='"+password+"'";
           sql=con.createStatement();  
           if(boo){
              ResultSet rs=sql.executeQuery(condition);
              boolean m=rs.next();
              if(m==true){ 
                  //调用登录成功的方法:
                  success(request,response,logname,password); 
                  RequestDispatcher dispatcher=
                  request.getRequestDispatcher("login.jsp");//转发
                  dispatcher.forward(request,response);
              }
              else{
                  String backNews="您输入的用户名不存在，或密码不般配";
                  //调用登录失败的方法:
                  fail(request,response,logname,backNews); 
              }
           }
           else{
                  String backNews="请输入用户名和密码";
                  fail(request,response,logname,backNews);
           }
           con.close();
      }
      catch(SQLException exp){
          String backNews=""+exp;
          fail(request,response,logname,backNews);
      }
   }
   public void doGet(HttpServletRequest request,HttpServletResponse response) 
                        throws ServletException,IOException{
      doPost(request,response);
   }
   public void success(HttpServletRequest request,HttpServletResponse response
                      ,String logname,String password) {
      Login loginBean=null;
      HttpSession session=request.getSession(true);
      try{  loginBean=(Login)session.getAttribute("loginBean");
            if(loginBean==null){
               loginBean=new Login();  //创建新的数据模型 
               session.setAttribute("loginBean",loginBean);
               loginBean=(Login)session.getAttribute("loginBean");
            }
            String name =loginBean.getLogname();
            if(name.equals(logname)) {
               loginBean.setBackNews(logname+"已经登录了");
               loginBean.setLogname(logname);
            }
            else {  //数据模型存储新的登录用户
                loginBean.setBackNews(logname+"登录成功");
                loginBean.setLogname(logname);
            }
      }
      catch(Exception ee){
            loginBean=new Login();  
            session.setAttribute("loginBean",loginBean);
            loginBean.setBackNews(logname+"登录成功");
            loginBean.setLogname(logname);
      }
   }
    public void fail(HttpServletRequest request,HttpServletResponse response
                      ,String logname,String backNews) {
        response.setContentType("text/html;charset=GB2312");
        try {
         PrintWriter out=response.getWriter();
         out.println("<html><body>");
         out.println("<h2>"+logname+"登录反馈结果<br>"+backNews+"</h2>") ;
         out.println("返回登录页面或主页<br>");
         out.println("<a href =login.jsp>登录页面</a>");
         out.println("</body></html>");
        }
        catch(IOException exp){}
    }
}

```

```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<%@ page import="mybean.data.Login" %>
<jsp:useBean id="loginBean" class="mybean.data.Login" scope="session"/>
<%@ page import="java.util.*" %>
<HTML><BODY bgcolor=cyan><Font size=2><CENTER>
<table>
 <td><A href="register.jsp"><font size=2>用户注册</font></A></td>
 <td><A href="login.jsp"><font size=2>用户登录</font></A></td>
</table>
<%   if(loginBean==null){
        response.sendRedirect("login.jsp");//重定向到登录页面
     }
     else {
       boolean b =loginBean.getLogname()==null||
                  loginBean.getLogname().length()==0;
       if(b)
         response.sendRedirect("login.jsp");//重定向到登录页面
     }
%>        
 <image src="image.jpg" width=220 height=200></image>
</CENTER></BODY></HTML>

```

image.jpg

![image](https://img1.zlogs.net/20/20200615204633.jpg)





## MVC模式与数据库操作 

​       本节的主要目的是学习使用MVC模式分页显示数据库表中的记录。 

> Javabean与Servlet管理 

> ​    本节的Javabean类的包名均为mybean.data；Servlet类的包名均为myservlet.control。由于Servlet类中要使用Javabean，所以为了能顺利地编译Servlet类，不要忘记将Tomcat安装目录lib子目录中的servlet-api.jar文件复制到Tomcat服务器所使用的JDK的扩展目录中，比如，复制到D:\jdk1.7\jre\lib\ext中。然后，按下列步骤进行编译和保存有关的字节码文件 。
> 1．保存Javabean类和Servlet类的源文件 
>    D:\ mybean\data 和 D:\myservlet\control
> 2．编译Javabean类 
> ​     D:> javac mybean\data\Javabean的源文件
> 3．编译Servlet类 
> ​      D:> javac myservlet\control\servlet的源文件 
> 4．将类的字节码文件保存到服务器 
> ​     ch9\WEB-INF\classes\mybean\data   和
> ​     ch9\WEB-INF\classes\myservlet\control



> 配置文件与数据库连接 

>    本节的Servlet类的包名均为myservlet.control，需要配置Web服务目录的web.xml文件，即将下面的web.xml文件保存到Tomcat安装目录的Web服务目录ch9中。根据本书使用的Tomcat安装目录及Web服务目录，需要将web.xml文件保存到
> D:\apache-tomcat-8.0.3\webapps\ch9\WEB-INF
> 目录中。
>   避免操作数据库出现中文乱码，连接中的代码是（用户是root，其密码是空）：
> String uri = "jdbc:mysql://127.0.0.1/数据库名?"+
>              "user=root&password=&characterEncoding=gb2312";
>   Connection con = DriverManager.getConnection(uri); 



​     web.xml 

```xml
<servlet>
    <servlet-name>database</servlet-name>
    <servlet-class>myservlet.control.HandleDatabase</servlet-class>
</servlet>
<servlet-mapping>
<servlet-name>database</servlet-name>
<url-pattern>/helpReadRecord</url-pattern>
</servlet-mapping>

```



> MVC设计细节

> ​    第7章曾使用bean读取数据库的记录（见7.6），该bean不仅要负责查询记录，而且要负责存储所查询到的记录。在MVC模式中，查询记录的任务由servlet对象负责，bean仅仅负责存储servlet对象所查询到的记录。

![image](https://img1.zlogs.net/20/20200615203237.png)



```
1．视图（JSP页面） 
      choiceDatabase.jsp ，showRecord.jsp 
2．模型（Javabean） 
   ShowRecordByPage.java 
3．控制器（servlet）
     HandleDatabase.java 
```

```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<HTML><BODY bgcolor=cyan><Font size=2>
    <FORM action="helpReadRecord" method="post" name="form">
      数据库的名字:<BR><INPUT type="text" name="databaseName">
     <BR>表的名字: <BR><INPUT type="text" name="tableName">
     <BR>每页显示记录数：
        <INPUT type="text" value="2" name="pageSize" size=6> 
        <INPUT type="submit" value="提交" name="submit">
    </FORM>
</Font></BODY></HTML>

```

```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<%@ page import="mybean.data.ShowRecordByPage" %> 
<HTML><BODY bgcolor=yellow><Font size=2>
 <jsp:useBean id="database" 
      type="mybean.data.ShowRecordByPage" scope="session"/>
   您查询的数据库：<jsp:getProperty name="database" property="databaseName"/>,
   查询的表：<jsp:getProperty name="database" property="tableName"/>。
   <BR>记录分 <jsp:getProperty name="database" property="pageAllCount"/> 页，
   每页最多显示 <jsp:getProperty name="database" property="pageSize"/> 条记录,
   目前显示第 <jsp:getProperty name="database" property="showPage"/> 页。
   <table border=1>
     <jsp:getProperty name="database" property="formTitle"/>  
     <jsp:getProperty name="database" property="presentPageResult"/>   
   </table>
    <table> 
      <tr><td>
          <FORM action="helpReadRecord" method="post" name="form">
          <INPUT type="hidden" value="previousPage" name="whichPage">
          <INPUT type="submit" value="上一页" name="submit">
          </FORM>
          </td>
         <td>
          <FORM action="helpReadRecord" method="post" name="form">
          <INPUT type="hidden" value="nextPage" name="whichPage">
          <INPUT type="submit" value="下一页" name="submit">
          </FORM>
          </td>
     </tr>
    </FORM>
</Font></BODY></HTML>

```

```java
package mybean.data;
import com.sun.rowset.*; 
public class ShowRecordByPage{
    CachedRowSetImpl rowSet=null;         //存储表中全部记录的行集对象
    int pageSize=10;                      //每页显示的记录数
    int pageAllCount=0;                   //分页后的总页数
    int showPage=1   ;                    //当前显示页 
    StringBuffer presentPageResult;      //显示当前页内容
    String databaseName="";              //数据库名称
    String tableName="";                 //表的名字
    StringBuffer formTitle=null;         //表头
    public void setRowSet(CachedRowSetImpl set){
       rowSet=set;
    }
    public CachedRowSetImpl getRowSet(){
       return rowSet;
    }
    public void setPageSize(int size){
       pageSize=size;
    }
    public int getPageSize(){
       return pageSize;
    } 
    public int getPageAllCount(){
       return pageAllCount;
    } 
    public void setPageAllCount(int n){
       pageAllCount=n; 
    }
    public void setShowPage(int n){
       showPage=n;
    }
    public int getShowPage(){
       return showPage;
    }
    public void setPresentPageResult(StringBuffer p){
       presentPageResult=p; 
    }
    public StringBuffer getPresentPageResult(){
       return presentPageResult; 
    }
    public void setDatabaseName(String s){
       databaseName=s.trim();
    }
    public String getDatabaseName(){
       return databaseName;
    }
    public void setTableName(String s){
       tableName=s.trim();
    }
    public String getTableName(){
       return tableName;
    }
    public void setFormTitle(StringBuffer s){
       formTitle=s;
    }
    public StringBuffer getFormTitle(){
       return formTitle;
    } 
}

```

```java
package myservlet.control;
import mybean.data.ShowRecordByPage;
import com.sun.rowset.*;
import java.sql.*;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class HandleDatabase extends HttpServlet{
   int 字段个数;
   CachedRowSetImpl rowSet=null;
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
      try {  Class.forName("com.mysql.jdbc.Driver");
      }
      catch(Exception e){} 
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response)
  throws ServletException,IOException{
      Connection con; 
      StringBuffer presentPageResult=new StringBuffer();
      ShowRecordByPage databaseBean=null;
      HttpSession session=request.getSession(true);
      try{   databaseBean=(ShowRecordByPage)session.getAttribute("database");
             if(databaseBean==null){
                databaseBean=new ShowRecordByPage(); //创建Javabean对象
                session.setAttribute("database",databaseBean);
             }
      }
      catch(Exception exp){
             databaseBean=new ShowRecordByPage();
             session.setAttribute("database",databaseBean);
      } 
      String databaseName=request.getParameter("databaseName");
      String tableName=request.getParameter("tableName");
      String ps=request.getParameter("pageSize");
      if(ps!=null){
         try{  int mm=Integer.parseInt(ps);
               databaseBean.setPageSize(mm);
         }
         catch(NumberFormatException exp){
               databaseBean.setPageSize(1);
         } 
      }
      int showPage=databaseBean.getShowPage();
      int pageSize=databaseBean.getPageSize();
      boolean boo=databaseName!=null&&tableName!=null&&
                  databaseName.length()>0&&tableName.length()>0;
      if(boo){ 
         databaseBean.setDatabaseName(databaseName);//数据存储在databaseBean中
         databaseBean.setTableName(tableName);      //数据存储在databaseBean中
         String uri="jdbc:mysql://127.0.0.1/"+databaseName;
         try{   字段个数=0;
                con=DriverManager.getConnection(uri,"root","");
                DatabaseMetaData metadata=con.getMetaData();
                ResultSet rs1=metadata.getColumns(null,null,tableName,null);
                int k=0;
                String 字段[]=new String[100]  ;
                while(rs1.next()){
                  字段个数++;
                  字段[k]=rs1.getString(4); //获取字段的名字
                  k++;
                }
                StringBuffer str=new StringBuffer();
                str.append("<tr>");
                for(int i=0;i<字段个数;i++)
                   str.append("<th>"+字段[i]+"</th>");
                str.append("</tr>");
                databaseBean.setFormTitle(str);  //数据存储在databaseBean中
                Statement sql=
                con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE,
                                                ResultSet.CONCUR_READ_ONLY);
                ResultSet rs=sql.executeQuery("SELECT * FROM "+tableName);
                rowSet=new CachedRowSetImpl();  //创建行集对象
                rowSet.populate(rs);
                con.close();                     //关闭连接
                databaseBean.setRowSet(rowSet);  //数据存储在databaseBean中
                rowSet.last();
                int m=rowSet.getRow();           //总行数
                int n=pageSize;
                int pageAllCount=((m%n)==0)?(m/n):(m/n+1);
                databaseBean.setPageAllCount(pageAllCount);
         }
         catch(SQLException exp){}
      }
      String whichPage=request.getParameter("whichPage");
      if(whichPage==null||whichPage.length()==0){
           showPage=1;
           databaseBean.setShowPage(showPage);
           CachedRowSetImpl rowSet=databaseBean.getRowSet();
           if(rowSet!=null){
             presentPageResult=show(showPage,pageSize,rowSet);
             databaseBean.setPresentPageResult(presentPageResult); 
           }
      }
      else if(whichPage.equals("nextPage")){
           showPage++;
           if(showPage>databaseBean.getPageAllCount())
             showPage=1;
           databaseBean.setShowPage(showPage);
           CachedRowSetImpl rowSet=databaseBean.getRowSet();
           if(rowSet!=null){
             presentPageResult=show(showPage,pageSize,rowSet);
             databaseBean.setPresentPageResult(presentPageResult); 
           }
      }
      else if(whichPage.equals("previousPage")){
           showPage--;
           if(showPage<=0)
             showPage=databaseBean.getPageAllCount();
           databaseBean.setShowPage(showPage);
           CachedRowSetImpl rowSet=databaseBean.getRowSet();
           if(rowSet!=null){
             presentPageResult=show(showPage,pageSize,rowSet);
             databaseBean.setPresentPageResult(presentPageResult); 
           }
      } 
      databaseBean.setPresentPageResult(presentPageResult);
      RequestDispatcher dispatcher=request.getRequestDispatcher("showRecord.jsp");
      dispatcher.forward(request,response);//请求showRecord.jsp显示数据
   } 
   public StringBuffer show(int page,int pageSize,CachedRowSetImpl rowSet){
      StringBuffer str=new StringBuffer();
      try{   rowSet.absolute((page-1)*pageSize+1);
             for(int i=1;i<=pageSize;i++){
                 str.append("<tr>");
                 for(int k=1;k<=字段个数;k++)
                    str.append("<td>"+rowSet.getString(k)+"</td>");
                 str.append("</tr>");
                 rowSet.next();
             }
       }
       catch(SQLException exp){}
       return str;
    }
    public  void  doGet(HttpServletRequest request,HttpServletResponse response) 
                        throws ServletException,IOException{
       doPost(request,response);
    }
}

```









## MVC模式与文件操作 

​       在MVC模式中，读取文件的工作由servlet对象负责，bean仅仅负责存储servlet对象所读取的文件内容。 
​     



> 本节设计一个Web应用，在该Web应用中有两个JSP页面：choiceFile.jsp和showFile.jsp、一个Javabean和一个servlet。用户在JSP页面choiceFile.jsp选择一个文件，提交给servlet，该servlet负责读取文件的有关信息存放到JavaBean中，并请求JSP页面showFile.jsp显示Javanean中的数据。 

​     web.xml 

```xml
<servlet>
    <servlet-name>helpReadFile</servlet-name>
    <servlet-class>myservlet.control.HandleFile</servlet-class>
</servlet>
<servlet-mapping>
    <servlet-name>helpReadFile </servlet-name>
    <url-pattern>/helpReadFile</url-pattern>
</servlet-mapping

```

> 模型（Javabean） 

> ​    本节的Javabean类的包名为mybean.data。FileMessage.java模型中的getXXX和setXXX方法可以显示和修改模型中的数据，但不参与数据的处理。请读者比较本节中的FileMessage.java和7.5中ReadFile.java的不同之处。
> ​     Javabean类的源文件FileMessage.java保存到：D:\mybean\data，如下列格式编译源文件，即带着包名形成的目录：
> D:> javac mybean\data\FileMessage.java
> ​    将编译得到的字节码文件FileMessage.class复制到
> ch9\WEB-INF\classes\mybean\data目录中。

```java
package mybean.data;
public class FileMessage {
   String filePath,fileName,fileContent;
   long fileLength;
   public void setFilePath(String str){
      filePath=str;
   }
   public String getFilePath(){
      return filePath; 
   }
   public void setFileName(String str){
      fileName=str;
   }
   public String getFileName(){
      return fileName; 
   }
   public void setFileContent(String str){
      fileContent=str;
   }
   public String getFileContent(){
      return fileContent; 
   }
   public void setFileLength(long len){
      fileLength=len; 
   }
   public long getFileLength(){
      return fileLength; 
   }
}

```







> 控制器（servlet） 

> HandeFile .java
>     控制器是名字为helpReadFile的servlet对象（见web.xml中的配置），由下面的HandleFile类负责创建。由于Servlet类中要使用Javabean，所以为了能顺利地编译Servlet类，不要忘记将Tomcat安装目录lib子目录中的servlet-api.jar文件复制到Tomcat服务器所使用的JDK的扩展目录中，比如，复制到D:\jdk1.7\jre\lib\ext中。  
>     Servlet类的包名为myservlet.control，将下面的Servlet类的源文件HandeFile.java保存到 D:\myservlet\control目录中，即保存时，让Servlet类的包名和Javabean类的包名形成的目录的父目录相同。用如下格式进行编译，即带着包名形成的目录：
> D:> javac myservlet\control\HandleFile.java
>     将编译得到的字节码文件HandeFile.class复制到
>        ch9\WEB-INF\classes\myservlet\control
> 目录中。

```java
package myservlet.control;
import mybean.data.FileMessage;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class HandleFile extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response)
                        throws ServletException,IOException{
      FileMessage file=new FileMessage();  //创建Javabean对象
      request.setAttribute("file",file);
      String filePath=request.getParameter("filePath");
      String fileName=request.getParameter("fileName");
      file.setFilePath(filePath);   //将数据存储在file中 
      file.setFileName(fileName);   
      try{   File f=new File(filePath,fileName);
             long length=f.length();
             file.setFileLength(length);
             FileReader in=new FileReader(f) ;
             BufferedReader inTwo=new BufferedReader(in);
             StringBuffer stringbuffer=new StringBuffer(); 
             String s=null;
             while ((s=inTwo.readLine())!=null) 
                stringbuffer.append("\n"+s);
             String content=new String(stringbuffer);
             file.setFileContent(content);
      }
      catch(IOException exp){} 
      RequestDispatcher dispatcher=request.getRequestDispatcher("showFile.jsp");
      dispatcher.forward(request, response);
   } 
   public  void  doGet(HttpServletRequest request,HttpServletResponse response) 
                        throws ServletException,IOException{
      doPost(request,response);
   }
}

```





> 视图（JSP页面） 

> ​    choiceFile.jsp 
> ​    在choiceFile.jsp页面可以输入文件的路径和名字，并提交给名字为handleFile的servlet对象。servlet对象负责读取文件，并将读取的内容以及相关的数据存储到数据模型bean中，然后请求showFile.jsp页面显示模型中的数据 。
> choiceFile.jsp （效果如图9.11） 
> showFile .jsp（效果如图9.12） 

![image](https://img1.zlogs.net/20/20200615203430.png)



```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<HTML><BODY bgcolor=cyan><Font size=2>
 <FORM action="helpReadFile" method="post" name="form">
 输入文件的路径(如:d:/2000):
 <INPUT type="text" name="filePath" size=12>
 <BR>输入文件的名字(如:Hello.java):
 <INPUT type="text" name="fileName" size=9>
 <BR><INPUT type="submit" value="读取" name="submit">
 </FORM>
</Font></BODY></HTML>

```

```jsp
<%@ page import="mybean.data.FileMessage" %> 
<%@ page contentType="text/html;charset=GB2312" %>
 <jsp:useBean id="file" type="mybean.data.FileMessage" scope="request"/>
<HTML><BODY bgcolor=yellow><Font size=2>
  文件的位置: <jsp:getProperty name="file" property="filePath"/>,
  文件的名字：<jsp:getProperty name="file" property="fileName"/>,
  文件的长度：<jsp:getProperty name="file" property="fileLength"/> 字节。
  <BR>文件的内容：
  <BR><TextArea  rows="6" cols="60">
       <jsp:getProperty name="file" property="fileContent"/>
     </TextArea>
</Font></BODY></HTML>

```

















































