# 数据库

## 连接mysql

### 加载JDBC-数据库驱动程序

+ 下载mysql-connector-java-5.1.28.zip，将该zip文件解压至硬盘，在解压后的目录下的mysql-connector-java-5.1.28-bin.jar文件就是连接MySQL数据库的JDBC-数据库驱动程序。

+ 将该驱动程序复制到Tomcat服务器所使用的JDK的扩展目录中（即java_home环境变量指定的JDK），比如：D:\jdk1.7\jre\lib\ext
+ 或复制到Tomcat服务器安装目录的`\common\lib`文件夹中，比如：D:\apache-tomcat-8.0.3\common\lib

```java
加载MySQL的JDBC-数据库驱动程序代码如下：
try{                   
    Class.forName("com.mysql.jdbc.Driver");
}
catch(Exception e){}
```

### 建立连接

​       为了能和MySQL数据库服务器管理的数据库建立连接，必须保证该MySQL数据库服务器已经启动，如果没有更改过MySQL数据库服务器的配置，那么该数据库服务器占用的端口是3306。假设MySQL数据库服务器所驻留的计算机的IP地址是192.168.100.1

+ 使用` Connection getConnection(String,String,String)`方法建立连接的代码如下：

```java
try{  String uri = "jdbc:mysql:// 192.168.100.1:3306/warehouse";
       String user ="root";
       String password ="99";
       con = DriverManager.getConnection(uri,user,password);
   }
catch(SQLException e){
      System.out.println(e);
}

```

+ 使用`Connection getConnection(String)`方法建立连接的代码如下：

```java
try{  
String uri = 
" jdbc:mysql://192.168.100.1:3306/warehouse?user=root&password=99";
      con = DriverManager.getConnection(uri);
   }
catch(SQLException e){
      System.out.println(e);
}
//如果root用户没有设置密码，那么将上述uri中的 &password=99更改为：&password= 
```

### 解决乱码

> 用户要和连接MySQL驻留在同一计算机上，使用的IP地址可以是127.0.0.1或localhost。另外，由于3306是MySQL数据库服务器的默认端口号，链接数据库时允许应用程序省略默认的3360端口号.

+ 数据库和表使用支持中文的字符编码
  + 在创建数据库时指定数据库使用的字符编码：
            create 数据库名 CHARACTER SET字符编码
  + 创建表时，可以指定某个字段使用的字符编码：
               字段名  类型 CHARACTER SET字符编码

```sql
create people CHARACTER SET gb2312
create table myList (
id int, 
name  varchar(100) CHARACTER SET gb2312,
PRIMARY KEY (id)
);
```

+ 连接数据库支持中文编码，避免操作数据库出现中文乱码

```java
JSP中连接MySQL数据库时，需要使用
Connection getConnection(java.lang.String) 
方法建立连接，而且向该方法参数传递的字符串是：
“jdbc:mysql://地址/数据库?user=用户&password=密码  &characterEncoding=gb2312";
```

```java
使用Connection getConnection(String)方法建立连接，连接代码是（假设用户是root，其密码是99）：
String uri = "jdbc:mysql://127.0.0.1/warehouse?"+"user=root&password=99&characterEncoding=gb2312";
```



> ​       例子1是一个简单的JSP页面，该页面中的Java程序片代码负责加载JDBC-驱动程序，并连接到数据库warehouse，查询product表中全部记录(见7.1节曾建立的warehouse数据库)，页面运行效果如图7.18。 

![image](https://img1.zlogs.net/20/20200615132453.png)



```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<%@ page import="java.sql.*" %>
<HTML><body bgcolor=#EEDDFF>
 <% Connection con;
    Statement sql; 
    ResultSet rs;
    try{  Class.forName("com.mysql.jdbc.Driver");
    }
    catch(Exception e){
       out.println("忘记把MySQL数据库的JDBC-数据库驱动程序复制到JDK的扩展目录中");
    }
    try { String uri= "jdbc:mysql://127.0.0.1/warehouse";
          String user="root";
          String password="";
          con=DriverManager.getConnection(uri,user,password);
          //也可以写成con=DriverManager.getConnection(uri+"?user=root&password=");
          sql=con.createStatement();
          rs=sql.executeQuery("SELECT * FROM product ");
          out.print("<table border=2>");
          out.print("<tr>");
            out.print("<th width=100>"+"产品号");
            out.print("<th width=100>"+"名称");
            out.print("<th width=50>"+"生产日期");
            out.print("<th width=50>"+"价格");
          out.print("</TR>");
          while(rs.next()){
            out.print("<tr>");
              out.print("<td >"+rs.getString(1)+"</td>"); 
              out.print("<td >"+rs.getString(2)+"</td>");
              out.print("<td >"+rs.getDate("madeTime")+"</td>"); 
              out.print("<td >"+rs.getFloat("price")+"</td>");
            out.print("</tr>") ; 
          }
          out.print("</table>");
          con.close();
    }
    catch(SQLException e){ 
          out.print(e);
    }
 %>
</body></HTML>

```





## 查询记录

​     和数据库建立连接后，就可以使用JDBC提供的API和数据库交互信息。比如查询、修改和更新数据库中的表等。
​      JDBC和数据库表进行交互的主要方式是使用SQL语句，JDBC提供的API可以将标准的SQL语句发送给数据库，实现和数据库的交互。



### 结果集与查询

+ 1．SQL查询语句与结果集

```sql
让连接对象con调用方法createStatement()创建这个SQL语句对象：
try{  Statement sql=con.createStatement();
   }
catch(SQLException e ){
      System.out.println(e); 
}
```

```sql
对于
ResultSet rs=sql.executeQuery("SELECT * FROM product");
内存的结果集对象rs的列数是4列，刚好和product的列数相同.
```

```sql
对于
ResultSet rs=
sql.executeQuery("SELECT name,price FROM product");
内存的结果集对象rs只有两列，第1列是name列、第2列是price列。
```

> ResultSet结果集一次只能看到一个数据行，使用next()方法走到下一数据行，获得一行数据后，ResultSet结果集可以使用getXxx方法获得字段值(列值)，将位置索引（第一列使用1，第二列使用2等等）或列名传递给getXxx方法的参数即可

![image](https://img1.zlogs.net/20/20200615142934.png)



+ 2．结果集的列名与列的数目

​      程序查询的时候。为了代码更加容易维护，希望知道数据库表的字段（列）的名字以及表的字段的个数，那么一个办法是使用返回到程序中的结果集来获取相关的信息。

```sql
假如结果集是rs
(1) 得到元数据对象metaData
   ResultSetMetaData metaData = rs.getMetaData();

(2)得到结果集的列的个数，即共有几列
   int columnCount = metaData.getColumnCount();
      
(3)结果集rs中的第i列的名字：
   String columnName = metaData.getColumnName(i);
```



### 随机查询

```sql
使用下述方法获得一个Statement对象：
Statement stmt=con.createStatement(int type,int concurrency);
type取值：
     ResultSet.TYPE_SCROLL_INSENSITIVE
或
     ResultSet.TYPE_SCROLL_SENSITIVE

Concurrency取值：
     ResultSet.CONCUR_READ_ONLY
或
     ResultSet.CONCUR_UPDATABLE

```

   根据参数的type、concurrency的取值情况，stmt返回相应类型的结果集：`ResultSet re=stmt.executeQuery(SQL语句);`



滚动查询经常用到ResultSet的下述方法：
public void first()：将游标移到结果集的第一行。
public void last()：将游标移到结果集的最后一行。
public int getRow()：得到当前游标所指行的行号，行号从1开始，如果结果集没有行，返回0
public boolean absolute(int row)：将游标移到参数row指定的行号。                                      





### 条件查询

`"select… from  表 where 字段 满足的条件"`



```sql
例如：
   "select * from product where price > 2000 and price<5000"
   "select * from product where name = 'java'"
   "select * from  product where name like '%里% "
```



> 使用MVC模式显示warehouse数据库product表中price字段值大于某个值的记录。

> ​     根据例子2中使用的servlet的名字及相关类，Web服务目录ch7的WEB-INF下的web.xml文件需包含如下内容。

```xml
<servlet>
    <servlet-name>queryByConditionServlet</servlet-name>
    <servlet-class>myservlet.control.Example7_2_Servlet</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>queryByConditionServlet</servlet-name>
  <url-pattern>/queryByConditionServlet</url-pattern>
</servlet-mapping>

```

> ​    模型（Javabean）
> Javabean模型Example7_2_Bean.java负责存储查询到的记录，在本例子中Example7_2_Bean创建的Javabean模型的id是resultBean，scope取值是request。

```java
package mybean.data;
public class Example7_2_Bean{
   String []columnName ;           //存放列名
   String [][] tableRecord=null;   //存放查询到的记录
   public Example7_2_Bean() {
      tableRecord = new String[1][1];
      columnName = new String[1]; 
   }
   public void setTableRecord(String [][] s){
      tableRecord=s;
   }
   public String [][] getTableRecord(){
      return tableRecord;
   }
   public void setColumnName(String [] s) {
      columnName = s;
   }
   public String [] getColumnName() {
      return columnName;
   }
}


```

> 视图（JSP页面）
>      视图部分由2个JSP页面构成，其中example7_2.jsp页面负责提供输入数据的视图，即用户可以在该页面输入查询的价格条件，然后将数据提交给名字是queryByConditionServlet的servlet。queryByConditionServlet负责查询数据库，并将结果存储到id为resultBean的Javabean数据模型中，然后请求视图中的showRecord.jsp显示数据模型resultBean中的数据。
> example7_2.jsp和showRecord.jsp的效果如图7.19(a)和图7.19(b)所示

```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<HTML><body bgcolor=cyan><font size=2>
<form action="queryByConditionServlet?dataBase=warehouse&tableName=product" 
     method="post" >
   查询warehouse数据库product表中
   <br>price值大于<input type=text name="price" value =-1 size=6>的记录
   <br>输入用户名：<input type=text name="user" value=root size=5>(默认root)
   <br>输入密码：  <input type="password" name="password" size=3>(默认空)     
  <br><input type=submit name="sub" value="提交">
</form>
</font></body></HTML> 

```



```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<jsp:useBean id="resultBean" 
     class="mybean.data.Example7_2_Bean" scope="request"/>
<HTML><body bgcolor=#DEEFF9><font size=2>
  <table border=1>
  <%  String []columnName=resultBean.getColumnName(); 
  %>
      <tr>
  <%  for(String s:columnName) {
  %>    <th><%= s %></th>
  <%  }
  %>  </tr>
  <%  String [][] record = resultBean.getTableRecord();
      for(int i=0;i<record.length;i++) {
  %>    <tr>
  <%     for(int j=0;j<record[i].length;j++) {
  %>        <td><%= record[i][j] %> </td>
  <%     }
  %>    </tr>
  <%  }
  %>
  </table>
</font></body></HTML>  

```

> 控制器（servlet）
> Example7_2_Sevlet负责创建名字是 queryByConditionServlet的servlet（见例子2前面web.xml文件的有关内容）。  
>      queryByConditionServlet查询warehouse数据库的product表中满足价格条件的记录，将结果存放到id是resultBean的Javabean数据模型中，
>      然后用转发的方法请求showRecord.jsp显示resultBean中的数据。

```java
package myservlet.control;
import mybean.data.Example7_2_Bean;
import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class Example7_2_Servlet extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response)
               throws ServletException,IOException{
      Example7_2_Bean resultBean=null;
      try{  resultBean=(Example7_2_Bean)request.getAttribute("resultBean");
            if(resultBean==null){
                resultBean=new Example7_2_Bean(); //创建Javabean对象
                request.setAttribute("resultBean",resultBean);
            }
      }
      catch(Exception exp){
            resultBean=new Example7_2_Bean();  //创建Javabean对象
            request.setAttribute("resultBean",resultBean);
      } 
     try{  Class.forName("com.mysql.jdbc.Driver");
     }
     catch(Exception e){} 
     String number = request.getParameter("price");
     if(number==null||number.length()==0)
        return;
     String dataBase = request.getParameter("dataBase");
     String tableName = request.getParameter("tableName"); 
     String user = request.getParameter("user");
     String password = request.getParameter("password");
     float p = Float.parseFloat(number); 
     Connection con;
     Statement sql; 
     ResultSet rs;
     try{ 
          String uri="jdbc:mysql://127.0.0.1/"+dataBase;
          con=DriverManager.getConnection(uri,user,password);
          sql=con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE,
                                 ResultSet.CONCUR_READ_ONLY);
          String condition ="SELECT * FROM "+tableName+" where price > "+p;
          rs=sql.executeQuery(condition);
          ResultSetMetaData metaData = rs.getMetaData();
          int columnCount = metaData.getColumnCount(); //得到结果集的列数
          String []columnName = new String[columnCount];
          for(int i=0;i<columnName.length;i++) {
             columnName[i] = metaData.getColumnName(i+1); //得到列名
          }
          resultBean.setColumnName(columnName);   //更新Javabean数据模型
          rs.last();
          int rowNumber=rs.getRow();  //得到记录数
          String [][] tableRecord=resultBean.getTableRecord();
          tableRecord = new String[rowNumber][columnCount];
          rs.beforeFirst();
          int i=0;
          while(rs.next()){
            for(int k=0;k<columnCount;k++) 
              tableRecord[i][k] = rs.getString(k+1);
            i++; 
          }
          resultBean.setTableRecord(tableRecord); //更新Javabean数据模型
          con.close();
          RequestDispatcher dispatcher=
          request.getRequestDispatcher("showRecord.jsp");
          dispatcher.forward(request,response);
     }
     catch(SQLException e){
          System.out.println(e);
     }  
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
           throws ServletException,IOException{
       doPost(request,response);
   }
}

```



## 更新、添加与删除记录

1．更新
Statement对象调用方法：
public int executeUpdate（String sqlStatement）;
实现对数据库表中记录的字段值的更新。例如，
executeUpdate("UPDATE product SET price = 6866 WHERE name='海尔电视机'");



2．添加
Statement对象调用方法：
public int executeUpdate（String sqlStatement）;
实现向数据库表中添加新的记录。例如，
executeUpdate("INSERT INTO students VALUES ('012','神通手机’,'2015-2-26',2687)");



3．删除
Statement对象调用方法：
public int executeUpdate（String sqlStatement）;
删除数据库表中的记录。例如：
executeUpdate("DELETE  FROM product WHERE number = '888' ");



> 下面的例子3使用MVC模式（有关知识见第6章）向warehouse数据库product表中插入。

> ​       根据例子3中使用的servlet的名字及相关类，Web服务目录ch7的WEB-INF下的web.xml文件需包含如下内容：

```xml
<servlet>
    <servlet-name>insertServlet</servlet-name>
    <servlet-class>myservlet.control.Example7_3_Servlet</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>insertServlet</servlet-name>
  <url-pattern>/insertServlet</url-pattern>
</servlet-mapping>

```

> ​    模型（Javabean）
> ​     Javabean模型例子2中的Example7_2_Bean.java完全相同，创建的Javabean模型的id是resultBean，scope取值是request。
>
> ch7/WEB-INF/classes/mybean/data/Example7_2_Bean.java

```java
package mybean.data;
public class Example7_2_Bean{
   String []columnName ;           //存放列名
   String [][] tableRecord=null;   //存放查询到的记录
   public Example7_2_Bean() {
      tableRecord = new String[1][1];
      columnName = new String[1]; 
   }
   public void setTableRecord(String [][] s){
      tableRecord=s;
   }
   public String [][] getTableRecord(){
      return tableRecord;
   }
   public void setColumnName(String [] s) {
      columnName = s;
   }
   public String [] getColumnName() {
      return columnName;
   }
}
```



> 视图（JSP页面）
>      视图部分由2个JSP页面构成，一个是example7_3.jsp，另一个是例子2中的showRecord.jsp，其中example7_3.jsp页面负责提供输入新记录提交给名字是insertServlet的servlet。
>       insertServlet负责将记录插入到数据库的表中，然后查询数据库的表，并将查询结果存储到id为resultBean的Javabean数据模型中，然后请求视图中的showRecor.jsp显示数据模型resultBean中的数据。example7_3.jsp和showRecord.jsp的效果如图7.20(a)和图7.20(b)所示。
>
> 为了避免出现中文乱码，数据库的连接方式采用：
> “jdbc:mysql://地址/数据库?user=用户&password=密码 &characterEncoding=gb2312";

```java
package myservlet.control;
import mybean.data.Example7_2_Bean; //引入例子2中的Javabean模型
import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class Example7_3_Servlet extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response)
               throws ServletException,IOException{
      Example7_2_Bean resultBean=null;
      try{  resultBean=(Example7_2_Bean)request.getAttribute("resultBean");
            if(resultBean==null){
                resultBean=new Example7_2_Bean(); //创建Javabean对象
                request.setAttribute("resultBean",resultBean);
            }
      }
      catch(Exception exp){
            resultBean=new Example7_2_Bean();  //创建Javabean对象
            request.setAttribute("resultBean",resultBean);
      } 
     try{  Class.forName("com.mysql.jdbc.Driver");
     }
     catch(Exception e){} 
     request.setCharacterEncoding("gb2312");
     String dataBase = request.getParameter("dataBase");
     String tableName = request.getParameter("tableName");
     String nu=request.getParameter("number");
     String na=request.getParameter("name");
     String mT=request.getParameter("madeTime");
     String pr=request.getParameter("price");
     if(nu==null||nu.length()==0) {
        fail(request,response,"添加记录失败,必须给出记录");
        return;
     }
     float p=Float.parseFloat(pr);
     String condition = "INSERT INTO "+tableName+" VALUES"+
      "("+"'"+nu+"','"+na+"','"+mT+"',"+p+")";
     Connection con;
     Statement sql; 
     ResultSet rs;
     try{ 
          String uri="jdbc:mysql://127.0.0.1/"+dataBase+"?"+
                      "user=root&password=&characterEncoding=gb2312";
          con=DriverManager.getConnection(uri);
          sql=con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE,
                                 ResultSet.CONCUR_READ_ONLY);
          sql.executeUpdate(condition);
          rs=sql.executeQuery("SELECT * FROM "+tableName);
          ResultSetMetaData metaData = rs.getMetaData();
          int columnCount = metaData.getColumnCount(); //得到结果集的列数
          String []columnName = new String[columnCount];
          for(int i=0;i<columnName.length;i++) {
             columnName[i] = metaData.getColumnName(i+1); //得到列名
          }
          resultBean.setColumnName(columnName);   //更新Javabean数据模型
          rs.last();
          int rowNumber=rs.getRow();  //得到记录数
          String [][] tableRecord=resultBean.getTableRecord();
          tableRecord = new String[rowNumber][columnCount];
          rs.beforeFirst();
          int i=0;
          while(rs.next()){
            for(int k=0;k<columnCount;k++) 
              tableRecord[i][k] = rs.getString(k+1);
            i++; 
          }
          resultBean.setTableRecord(tableRecord); //更新Javabean数据模型
          con.close();
          RequestDispatcher dispatcher=
          request.getRequestDispatcher("showRecord.jsp");
          dispatcher.forward(request,response);
     }
     catch(SQLException e){
          System.out.println(e);
          fail(request,response,"添加记录失败:"+e.toString());
     }  
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
           throws ServletException,IOException{
       doPost(request,response);
   }
   public void fail(HttpServletRequest request,HttpServletResponse response,
                      String backNews) {
        response.setContentType("text/html;charset=GB2312");
        try {
         PrintWriter out=response.getWriter();
         out.println("<html><body>");
         out.println("<h2>"+backNews+"</h2>") ;
         out.println("返回");
         out.println("<a href =example7_3.jsp>输入记录</a>");
         out.println("</body></html>");
        }
        catch(IOException exp){} 
    }
}

```





```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<jsp:useBean id="resultBean" 
     class="mybean.data.Example7_2_Bean" scope="request"/>
<HTML><body bgcolor=#DEEFF9><font size=2>
  <table border=1>
  <%  String []columnName=resultBean.getColumnName(); 
  %>
      <tr>
  <%  for(String s:columnName) {
  %>    <th><%= s %></th>
  <%  }
  %>  </tr>
  <%  String [][] record = resultBean.getTableRecord();
      for(int i=0;i<record.length;i++) {
  %>    <tr>
  <%     for(int j=0;j<record[i].length;j++) {
  %>        <td><%= record[i][j] %> </td>
  <%     }
  %>    </tr>
  <%  }
  %>
  </table>
</font></body></HTML>  

```



## 用结果集操作数据库中的表

​       尽管可以用SQL语句对数据库中表进行更新、插入操作，但也可以使用内存中ResultSet结果集对底层数据库表进行更新和插入操作（这些操作由系统自动转化为相应的SQL语句），优点是不必熟悉有关更新、插入的SQL语句，而且方便编写代码，缺点是，必须要事先返回结果集。



### 更新记录

使用结果集更新数据库表中第n行记录中某列的值的步骤是：

+ 1.结果集rs的游标移动到第n行
             rs.absolute(n);
+ 2.结果集将第n行的某列的列值更新
  例如  更新列名是columnName的日期值是x指定的值：
           updateDate(String columnName, Date x) 
+ 3.更新数据库中的表
  最后，结果集调用updateRow()方法用结果集中的第n行更新数据库表中的第n行记录。
         以下代码片段更新product表中的第3行记录的name列（字段）的值。
  rs.absolute(3);
  rs.updateString("name", "IBM PC");
  rs.updateRow();





### 插入记录

使用结果集向数据库表中插入（添加）一行记录步骤是：

+ 1.结果集rs的游标移动到插入行
             rs.moveToInsertRow();

+ 2.更新插入行的列值
   例如：
  rs.updateString(1, "c002");
  rs.updateString(2, "IBM iPad");
  rs.updateDate(3,Date());
  rs.updateDouble(4, 5356);

+ 3.插入记录

  最后，结果集调用insertRow()方法用结果集中的插入行向数据库表中插入一行新记录。



>  下面的例子4使用MVC模式向warehouse数据库product表中插入录，但和前面的例子3不同的是，例子4不直接使用SQL语句，而是使用结果集操作数据库中的表。

> 根据例子4中使用的servlet的名字及相关类，Web服务目录ch7的WEB-INF下的web.xml文件需包含如下内容

```xml
<servlet>
    <servlet-name>insertBySetServlet</servlet-name>
    <servlet-class>myservlet.control.Example7_4_Servlet</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>insertBySetServlet</servlet-name>
  <url-pattern>/insertBySetServlet</url-pattern>
</servlet-mapping>

```



> ​    模型（Javabean）
> ​       Javabean模型与例子2中的Example7_2_Bean.java完全相同，创建的Javabean模型的id是resultBean，scope取值是request。



> 视图（JSP页面）
>        视图部分由2个JSP页面构成，一个是example7_4.jsp，另一个是例子2中的showRecord.jsp。
>       其中example7_4.jsp页面负责提供输入新记录的视图，即用户可以在该页面输入要添加的记录，然后将要添加的记录提交给名字是insertBySetServlet的servlet。
>       insertBySetServlet负责将记录插入到数据库的表中，然后查询数据库的表，并将查询结果存储到id为resultBean的Javabean数据模型中，然后请求视图中的showRecor.jsp显示数据模型resultBean中的数据。example7_4.jsp和showRecord.jsp的效果如图7.21(a)和图7.21(b)所示。

```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<HTML><body bgcolor=#AAFFEE><font size=2>
<form action="insertServlet?dataBase=warehouse&tableName=product" method=post>
<b>添加新记录:<br>
产品号：<input type="text" name="number" size=20>
<br>名称：<input type="text" name="name" size=22>
<br>生产日期(日期必须用-或/格式)：
<br><input type="text" name="madeTime" size=18>
<br>价格：<input type="text" name="price" size=12>
<br><input type="submit" name="b" value="提交">
</font></body></HTML>

```





> 控制器（servlet）
>      Example7_4_Sevlet负责创建名字是insertBySetServlet的servlet（见例子4前面web.xml文件的有关内容）。insertBySetServlet使用结果集操作数据库，并向数据库warehouse的product表插入记录，然后查询product表中的全部记录，将结果存放到id是resultBean的Javabean数据模型中，然后用转发的方法请求showRecod.jsp显示resultBean中的数据.
>
> ​       为了避免出现中文乱码，数据库的连接方式采用：
> `"jdbc:mysql://地址/数据库?user=用户&password=密码
> &characterEncoding=gb2312";`

```java
package myservlet.control;
import mybean.data.Example7_2_Bean; //引入例子2中的Javabean模型
import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.Calendar;
public class Example7_4_Servlet extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response)
               throws ServletException,IOException{
      Example7_2_Bean resultBean=null;
      try{  resultBean=(Example7_2_Bean)request.getAttribute("resultBean");
            if(resultBean==null){
                resultBean=new Example7_2_Bean(); //创建Javabean对象
                request.setAttribute("resultBean",resultBean);
            }
      }
      catch(Exception exp){
            resultBean=new Example7_2_Bean();  //创建Javabean对象
            request.setAttribute("resultBean",resultBean);
      } 
     try{  Class.forName("com.mysql.jdbc.Driver");
     }
     catch(Exception e){} 
     request.setCharacterEncoding("gb2312");
     String dataBase = request.getParameter("dataBase");
     String tableName = request.getParameter("tableName");
     String number=request.getParameter("number");
     String name=request.getParameter("name");
     String madeTime=request.getParameter("madeTime");
     String pr=request.getParameter("price");
     if(number==null||number.length()==0) {
        fail(request,response,"添加记录失败,必须给出记录");
        return;
     }
     float price=Float.parseFloat(pr);
     Connection con;
     Statement sql; 
     ResultSet rs;
     try{ 
          String uri="jdbc:mysql://127.0.0.1/"+dataBase+"?"+
                      "user=root&password=&characterEncoding=gb2312";
          con=DriverManager.getConnection(uri);
          sql=con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE,
                                 ResultSet.CONCUR_READ_ONLY);
          rs=sql.executeQuery("SELECT * FROM "+tableName);
          rs.moveToInsertRow();      //rs的游标移动到插入行
          rs.updateString(1,number); //更新结果集
          rs.updateString(2, name); //更新结果集 
          String [] str=madeTime.split("[-/]");//输入的日期必须用-或/格式
          int year=Integer.parseInt(str[0]);
          int month=Integer.parseInt(str[1]); 
          int day=Integer.parseInt(str[2]);
          Calendar calendar =Calendar.getInstance();
          calendar.set(year,month-1,day); 
          Date date=new java.sql.Date(calendar.getTimeInMillis());
          rs.updateDate(3,date);     //更新结果集
          rs.updateDouble(4,price);  //更新结果集
          rs.insertRow();     //向表插入一行记录
          rs=sql.executeQuery("SELECT * FROM "+tableName);
          ResultSetMetaData metaData = rs.getMetaData();
          int columnCount = metaData.getColumnCount(); //得到结果集的列数
          String []columnName = new String[columnCount];
          for(int i=0;i<columnName.length;i++) {
             columnName[i] = metaData.getColumnName(i+1); //得到列名
          }
          resultBean.setColumnName(columnName);   //更新Javabean数据模型
          rs.last();
          int rowNumber=rs.getRow();  //得到记录数
          String [][] tableRecord=resultBean.getTableRecord();
          tableRecord = new String[rowNumber][columnCount];
          rs.beforeFirst();
          int i=0;
          while(rs.next()){
            for(int k=0;k<columnCount;k++) 
              tableRecord[i][k] = rs.getString(k+1);
            i++; 
          }
          resultBean.setTableRecord(tableRecord); //更新Javabean数据模型
          con.close();
          RequestDispatcher dispatcher=
          request.getRequestDispatcher("showRecord.jsp");
          dispatcher.forward(request,response);  //转发
     }
     catch(SQLException e){
          System.out.println(e);
          fail(request,response,"添加记录失败:"+e.toString());
     }  
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
           throws ServletException,IOException{
       doPost(request,response);
   }
   public void fail(HttpServletRequest request,HttpServletResponse response,
                      String backNews) {
        response.setContentType("text/html;charset=GB2312");
        try {
         PrintWriter out=response.getWriter();
         out.println("<html><body>");
         out.println("<h2>"+backNews+"</h2>") ;
         out.println("返回");
         out.println("<a href =example7_4.jsp>输入记录</a>");
         out.println("</body></html>");
        }
        catch(IOException exp){} 
    }
}

```



## 预处理语句

​      Java提供了更高效率的数据库操作机制，就是PreparedStatement对象，该对象被习惯地称作预处理语句对象。本节学习怎样使用预处理语句对象操作数据库中的表。



### 预处理语句优点

Connection连接对象con调用prepareStatement(String sql)方法：
`PreparedStatement pre=con.prepareStatement(String sql);`
对参数sql指定的SQL语句进行预编译处理.

那么pre调用下列方法都可以使得该底层内部命令被数据库执行：  

```java
ResultSet executeQuery()
boolean execute()
int executeUpdate()
```

​      只要编译好了PreparedStatement对象pre，那么pre可以随时地执行上述方法，提高了访问数据库的速度。



> 在下面的例5使用预处理语句来查询warehouse数据库中product表的全部记录

```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<%@ page import="java.sql.*" %>
<HTML><body bgcolor=#EEDDFF>
 <% Connection con;
    PreparedStatement sql; //预处理语句
    ResultSet rs;
    try{  Class.forName("com.mysql.jdbc.Driver");
    }
    catch(Exception e){
       out.println("忘记把MySQL数据库的JDBC-数据库驱动程序复制到JDK的扩展目录中");
    }
    try { String uri= "jdbc:mysql://127.0.0.1/warehouse";
          String user="root";
          String password="";
          con=DriverManager.getConnection(uri,user,password);
          sql=con.prepareStatement("SELECT * FROM product");
          rs=sql.executeQuery();
          out.print("<table border=2>");
          out.print("<tr>");
            out.print("<th width=100>"+"产品号");
            out.print("<th width=100>"+"名称");
            out.print("<th width=50>"+"生产日期");
            out.print("<th width=50>"+"价格");
          out.print("</TR>");
          while(rs.next()){
            out.print("<tr>");
              out.print("<td >"+rs.getString(1)+"</td>"); 
              out.print("<td >"+rs.getString(2)+"</td>");
              out.print("<td >"+rs.getDate("madeTime")+"</td>"); 
              out.print("<td >"+rs.getFloat("price")+"</td>");
            out.print("</tr>") ; 
          }
          out.print("</table>");
          con.close();
    }
    catch(SQLException e){ 
          out.print(e);
    }
 %>
</body></HTML>

```



### 使用通配符

在对SQL进行预处理时可以使用通配符“？”来代替字段的值。例如：

```sql
prepareStatement pre=con.prepareStatement("SELECT * FROM product WHERE price < ? ");
```

先调用相应的方法设置通配符“？”代表的具体值，比如：
`pre.setDouble(1,6565);`
指定上述预处理语句pre中第1个通配符“？”代表的值是6565。

​     通配符按着它们在预处理的“SQL语句”中从左至右依次出现的顺序分别被称做第1个、第2个… 第m个通配符。

预处理语句设置通配符“？”的值的常用方法有：

```java
void setDate(int parameterIndex,Date x)
void setDouble(int parameterIndex,double x)
void setFloat(int parameterIndex,float x)
```



>  例子6使用MVC模式更新warehouse数据库product表中的记录，但和前面的例子不同的是，这里使用了预处理语句。

根据例子6中使用的servlet的名字及相关类，Web服务目录ch7的WEB-INF下的web.xml文件需包含如下内容

```xml
<servlet>
    <servlet-name>preparedServlet</servlet-name>
    <servlet-class>myservlet.control.Example7_6_Servlet</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>preparedServlet</servlet-name>
  <url-pattern>/preparedServlet</url-pattern>
</servlet-mapping>

```



> ​    模型（Javabean）
> ​     Javabean模型与例子2中的Example7_2_Bean.java完全相同，创建的Javabean模型的id是resultBean，scope取值是request。

> 视图（JSP页面）
>        视图部分由2个JSP页面构成，一个是example7_6.jsp，另一个是例子2中的showRecord.jsp(showRecod.jsp的代码见例子2的视图部分)。example7_6.jsp页面将要更新的记录，提交给名字是preparedServlet的servlet。preparedServlet负责更新数据库表中的记录，然后查询数据库的表，并将查询结果存储到id为resultBean的Javabean数据模型中，然后请求视图中的showRecord.jsp（见例子2中的视图部分）显示数据模型resultBean中的数据。example7_6.jsp和showRecord.jsp的效果如图7.22(a)和图7.22(b)所示

```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<HTML><body bgcolor=#AAFFEE><font size=2>
<form action="preparedServlet" method=post>
<b>输入主键number是<input type="text" name="number" size=10><br>
   的name,madeTime和price的更新值：<br>
   name:<input type="text" name="name" size=7><br>
   madeTime:<input type="text" name="madeTime" size=10><br>
   price:<input type="text" name="price" size=8><br>
  <input type="submit" name="b" value="提交">
</font></body></HTML>     

```

> 控制器（servlet）
>  Example7_6_Servlet负责创建名字是insertServlet的servlet（见例子3前面web.xml文件的有关内容）。insertServlet负责向数据库warehouse的product表插入记录，并查询product表中的全部记录，将结果存放到id是resultBean的Javabean数据模型中，然后用转发的方法请求showRecod.jsp显示resultBean中的数据。

> 为了避免出现中文乱码，数据库的连接方式采用：
> “jdbc:mysql://地址/数据库?user=用户&password=密码 &characterEncoding=gb2312";

```jsp
package myservlet.control;
import mybean.data.Example7_2_Bean; //引入例子2中的Javabean模型
import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.Calendar;
public class Example7_6_Servlet extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response)
               throws ServletException,IOException{
      Example7_2_Bean resultBean=null;
      try{  resultBean=(Example7_2_Bean)request.getAttribute("resultBean");
            if(resultBean==null){
                resultBean=new Example7_2_Bean(); //创建Javabean对象
                request.setAttribute("resultBean",resultBean);
            }
      }
      catch(Exception exp){
            resultBean=new Example7_2_Bean();  //创建Javabean对象
            request.setAttribute("resultBean",resultBean);
      } 
     try{  Class.forName("com.mysql.jdbc.Driver");
     }
     catch(Exception e){} 
     request.setCharacterEncoding("gb2312");
     String number=request.getParameter("number");
     String name=request.getParameter("name");
     String madeTime=request.getParameter("madeTime");
     String pr=request.getParameter("price");
     if(number==null||number.length()==0) {
        fail(request,response,"更新记录失败,必须给出记录");
        return;
     }
     float price=Float.parseFloat(pr);
     String [] str=madeTime.split("[-/]");//输入的日期必须用-或/格式
     int year=Integer.parseInt(str[0]);
     int month=Integer.parseInt(str[1]); 
     int day=Integer.parseInt(str[2]);
     Calendar calendar =Calendar.getInstance();
     calendar.set(year,month-1,day); 
     Date date=new Date(calendar.getTimeInMillis());
     Connection con;
     PreparedStatement sql; //预处理语句 ; 
     ResultSet rs;
     try{ 
          String uri="jdbc:mysql://127.0.0.1/warehouse?"+
                      "user=root&password=&characterEncoding=gb2312";
          con=DriverManager.getConnection(uri);
          String condition =
         "UPDATE product SET name = ?,price = ?,madeTime = ?  WHERE number=?";
          sql=con.prepareStatement(condition);  
          sql.setString(1,name);   //设置第1个统配符“？”代表的具体值
          sql.setFloat(2,price);   //设置第2个统配符“？”代表的具体值
          sql.setDate(3,date);     //设置第3个统配符“？”代表的具体值
          sql.setString(4,number); //设置第4个统配符“？”代表的具体值
          sql.executeUpdate();
          sql=con.prepareStatement("select * from product");
          rs=sql.executeQuery();
          ResultSetMetaData metaData = rs.getMetaData();
          int columnCount = metaData.getColumnCount(); //得到结果集的列数
          String []columnName = new String[columnCount];
          for(int i=0;i<columnName.length;i++) {
             columnName[i] = metaData.getColumnName(i+1); //得到列名
          }
          resultBean.setColumnName(columnName);   //更新Javabean数据模型
          rs.last();
          int rowNumber=rs.getRow();  //得到记录数
          String [][] tableRecord=resultBean.getTableRecord();
          tableRecord = new String[rowNumber][columnCount];
          rs.beforeFirst();
          int i=0;
          while(rs.next()){
            for(int k=0;k<columnCount;k++) 
              tableRecord[i][k] = rs.getString(k+1);
            i++; 
          }
          resultBean.setTableRecord(tableRecord); //更新Javabean数据模型
          con.close();
          RequestDispatcher dispatcher=
          request.getRequestDispatcher("showRecord.jsp");
          dispatcher.forward(request,response);  //转发
     }
     catch(SQLException e){
          System.out.println(e);
          fail(request,response,"更新记录失败:"+e.toString());
     }  
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
           throws ServletException,IOException{
       doPost(request,response);
   }
   public void fail(HttpServletRequest request,HttpServletResponse response,
                      String backNews) {
        response.setContentType("text/html;charset=GB2312");
        try {
         PrintWriter out=response.getWriter();
         out.println("<html><body>");
         out.println("<h2>"+backNews+"</h2>") ;
         out.println("返回");
         out.println("<a href =example7_6.jsp>输入记录</a>");
         out.println("</body></html>");
        }
        catch(IOException exp){} 
    }
}

```



## 事务

​     事务由一组SQL语句组成，所谓“事务处理”是指：应用程序保证事务中的SQL语句要么全部都执行，要么一个都不执行。      

```sql
事务处理步骤如下：
1．连接对象使用setAutoCommit(boolean autoCommit)方法
将参数autoCommit取值为false来关闭自动提交模式：
con.setAutoCommit(false);
2．commit()方法
     con调用commit()方法就是让事务中的SQL语句全部生效。
3．rollback()方法
     只要事务中任何一个SQL语句没有生效,就抛出SQLException异常。在处理SQLException异常时,必须让con调用rollback()方法,其作用是撤消事务中成功执行过的SQL语句对数据库数据所做的更新、插入或删除操作.

```



> ​      为了例子7的需要，我们在bank数据库中创建了表user表,表的字段及属性如下：
> name(文本)  userMoney(双精度型) 
> ​     例子7使用了事务处理,将user表中name字段是geng的userMoney的值减少50,并将减少的50增加到name字段是zhang的userMony属性值上。运行效果如图7.23.

```jsp
<%@ page import="java.sql.*" %>
<%@ page contentType="text/html;charset=gb2312" %>
<HTML><body bgcolor=AAEF9E><font size=2>
<%  Connection con=null;
    Statement sql; 
    ResultSet rs;
    try { Class.forName("com.mysql.jdbc.Driver");  
    } 
    catch(ClassNotFoundException e){}
    try{  int n=50;
          String uri=
         "jdbc:mysql://127.0.0.1/bank?"+
         "user=root&password=&characterEncoding=gb2312";
          con=DriverManager.getConnection(uri);
          con.setAutoCommit(false);       //关闭自动提交模式
          sql=con.createStatement();
          rs=sql.executeQuery("SELECT userMoney FROM user WHERE name='geng'");
          rs.next();
          double gengMoney=rs.getDouble("userMoney");
          rs=sql.executeQuery("SELECT userMoney FROM user WHERE name='zhang'");
          rs.next();
          double zhangMoney=rs.getDouble("userMoney");
          out.print("转账前geng的userMoney的值是"+gengMoney+"<br>");
          out.print("转账前zhang的userMoney的值是"+zhangMoney+"<br>");
          gengMoney=gengMoney-n;
          if(gengMoney>=0) {
            zhangMoney=zhangMoney+n;
            sql.executeUpdate
            ("UPDATE user SET userMoney ="+gengMoney+" WHERE name='geng'");
            sql.executeUpdate
           ("UPDATE user SET userMoney="+zhangMoney+" WHERE name='zhang'");
            con.commit();                 //开始事务处理
          }
          rs=sql.executeQuery("SELECT * FROM user WHERE name='zhang'||name='geng'"); 
          out.println("<b>转账后的情况如下:<br>"); 
          while(rs.next()) {
              out.print(rs.getString(1)+"	");
              out.print(rs.getString(2)); 
              out.print("<br>");
          }
          con.close();
     }
     catch(SQLException e){
          try{ con.rollback();             //撤消事务所做的操作
          }
          catch(SQLException exp){}
          out.println(e);
     }
%>
</font></body></HTML>

```



## 分页显示记录

+ 可以使用二维数组table存放表的记录，即用二维数组table中的行（一维数组table[i]）存放一条记录。
+ 假设table存放了m行记录，准备每页显示n行，那么，总页数的计算公式：
  + 如果m除以n的余数大于0,总页数等于m除以n的商加1；
  + 如果m除以n的余数等于0，总页数等于m除以n的商。
    +  总页数=(m%n)==0?(m/n):(m/n+1);
+ 如果准备显示第p页的内容，应当从tablel第(p-1)*n行开始，连续输出n行（最后一页可能不足n行）。



> ​     下面的例子8使用MVC模式分页显示warehouse数据库product表中的记录。

> ​     根据例子8中使用的servlet的名字及相关类，Web服务目录ch7的WEB-INF下的web.xml文件需包含如下内容

```xml
<servlet>
    <servlet-name>queryAllServlet</servlet-name>
    <servlet-class>myservlet.control.Example7_8_Servlet</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>queryAllServlet</servlet-name>
  <url-pattern>/queryAllServlet</url-pattern>
</servlet-mapping>

```

> ​    模型（Javabean）
> ​      Javabean模型的id是pageBean（Example7_8_Bean创建），生命周期是session，用于存储数据库中的记录。

```java
package mybean.data;
public class Example7_8_Bean{
   String []columnName ;           //存放列名
   String [][] tableRecord=null;   //存放查询到的记录
   int pageSize=1;                      //每页显示的记录数
   int totalPages=1;                     //分页后的总页数
   int currentPage =1   ;                 //当前显示页 
   public void setTableRecord(String [][] s){
      tableRecord=s;
   }
   public String [][] getTableRecord(){
      return tableRecord;
   }
   public void setColumnName(String [] s) {
      columnName = s;
   }
   public String [] getColumnName() {
      return columnName;
   }
   public void setPageSize(int size){
      pageSize=size;
   }
   public int getPageSize(){
      return pageSize;
   } 
   public int getTotalPages(){
      return totalPages;
   } 
   public void setTotalPages(int n){
      totalPages=n; 
   }
   public void setCurrentPage(int n){
      currentPage =n;
   }
   public int getCurrentPage(){
      return currentPage ;
   }
}


```





> 视图（JSP页面）
>
> 视图部分由2个JSP页面构成，其中example7_8.jsp页面负责提供输入数据的视图，即用户可以在该页面输入数据库的名、表名、密码等信息，然后提交给名字是queryAllServlet的servlet。queryAllServlet负责查询数据库，并将结果存储到id为pageBean的Javabean数据模型中，然后请求视图中的example7_8_pageShow.jsp页面负责分页显示pageBean的数据。example7_8.jsp和example7_8_pageShow.jsp的效果如图7.24(a)和图7.24(b)所示。

```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<HTML><body bgcolor=#AAFFEE><font size=2>
<form action="queryAllServlet" method=post>
<b>数据库:<input type="text" name="dataBase" size=22 value =warehouse>
<br>表名：<input type="text" name="tableName" size=23 value=product>
<br>用户名(默认root)：<input type="text" name="user" size=10 value=root>
<br>用户密码(默认空)：<input type="text" name="password" size=10>
<br><input type="submit" name="b" value="提交">
</form>
</font></body></HTML>     

```



```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<jsp:useBean id="pageBean" class="mybean.data.Example7_8_Bean" scope="session"/>
<HTML><body bgcolor=#9FEFDF><center>
<br>当前显示的内容是：
<jsp:setProperty name="pageBean" property="pageSize" param="pageSize"/>
<jsp:setProperty name="pageBean" property="currentPage" param="currentPage"/>
  <table border=1>
  <%
      String [][] table=pageBean.getTableRecord();
      if(table==null) {
         out.print("没有记录");
         return;
      }
      String []columnName=pageBean.getColumnName();
      if(columnName!=null) { 
        out.print("<tr>");
        for(int i=0;i<columnName.length;i++){
          out.print("<th>"+columnName[i]+"</th>");
        }
        out.print("</tr>");
      } 
      int totalRecord = table.length;
      out.println("全部记录数"+totalRecord); //全部记录数
      int pageSize=pageBean.getPageSize();  //每页显示的记录数
      int totalPages = pageBean.getTotalPages();
      if(totalRecord%pageSize==0)
           totalPages = totalRecord/pageSize;//总页数
      else
           totalPages = totalRecord/pageSize+1;
      pageBean.setPageSize(pageSize);
      pageBean.setTotalPages(totalPages);
      if(totalPages>=1) {
         if(pageBean.getCurrentPage()<1)
             pageBean.setCurrentPage(pageBean.getTotalPages());
         if(pageBean.getCurrentPage()>pageBean.getTotalPages())
             pageBean.setCurrentPage(1);
         int index=(pageBean.getCurrentPage()-1)*pageSize;
         int start=index;  //table的currentPage页起始位置
         for(int i=index;i<pageSize+index;i++) { 
            if(i==totalRecord)
               break;
            out.print("<tr>");
            for(int j=0;j<columnName.length;j++) {
                out.print("<td>"+table[i][j]+"</td>");
            }
            out.print("</tr>");
        }
     }
%>
 </table>
 <br>每页最多显示<jsp:getProperty name="pageBean" property="pageSize"/>条信息
 <br>当前显示第<font color=blue>
     <jsp:getProperty name="pageBean" property="currentPage"/>
   </font>页,共有
   <font color=blue><jsp:getProperty name="pageBean" property="totalPages"/>
   </font>页。
<table>
  <tr><td><form action="" method=post>
          <input type=hidden name="currentPage" value=
         "<%=pageBean.getCurrentPage()-1 %>">
           <input type=submit name="g" value="上一页"></form></td>
      <td><form action="" method=post>
          <input type=hidden name="currentPage"
           value="<%=pageBean.getCurrentPage()+1 %>">
          <input type=submit name="g" value="下一页"></form></td></tr>
 <tr><td> <form action="" method=post>
          每页显示<input type=text name="pageSize" value =1 size=3>
          条记录<input type=submit name="g" value="确定"></form></td>
      <td> <form action="" method=post>
           输入页码：<input type=text name="currentPage" size=2 >
           <input type=submit name="g" value="提交"></form></td></tr>
</table>
</center>
</body></HTML>

```





> 控制器（servlet）
> Example7_8_Servlet负责创建名字是queryAllServlet的servlet（见例子8前面web.xml文件的有关内容）。queryAllServlet查询数据库表中的全部记录，将结果存放到id是pageBean的Javabean数据模型中，然后用转发的方法请求example7_8_pageShow.jsp显示pageBean中的数据。

```java
package myservlet.control;
import mybean.data.Example7_8_Bean;
import java.sql.*;
import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
public class Example7_8_Servlet extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
      try {  Class.forName("com.mysql.jdbc.Driver");
      }
      catch(Exception e){} 
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response) 
                        throws ServletException,IOException{
      request.setCharacterEncoding("gb2312");
      String dataBase= request.getParameter("dataBase");
      String tableName= request.getParameter("tableName");
      String user= request.getParameter("user");
      String password= request.getParameter("password");
      boolean boo =( dataBase==null||dataBase.length()==0);
      boo = boo||( tableName==null||tableName.length()==0);
      boo = boo||( user==null||user.length()==0);
      if(boo) {
         fail(request,response,"查询失败");
      }
      HttpSession session=request.getSession(true); 
      Connection con=null; 
      Example7_8_Bean pageBean=null;
      try{ 
           pageBean=(Example7_8_Bean)session.getAttribute("pageBean");
           if(pageBean==null){
              pageBean=new Example7_8_Bean();  //创建Javabean对象
              session.setAttribute("pageBean",pageBean);
           }
      }
      catch(Exception exp){
           pageBean=new Example7_8_Bean();  
           session.setAttribute("pageBean",pageBean);
      } 
      String uri="jdbc:mysql://127.0.0.1/"+dataBase;
      try{ 
          con=DriverManager.getConnection(uri,user,password);
          Statement sql=con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE,
                                                ResultSet.CONCUR_READ_ONLY);
          ResultSet rs=sql.executeQuery("SELECT * FROM "+tableName);
          ResultSetMetaData metaData = rs.getMetaData();
          int columnCount = metaData.getColumnCount(); //得到结果集的列数
          String []columnName = new String[columnCount];
          for(int i=0;i<columnName.length;i++) {
             columnName[i] = metaData.getColumnName(i+1); //得到列名
          }
          pageBean.setColumnName(columnName);   //更新Javabean数据模型
          rs.last();
          int rowNumber=rs.getRow();  //得到记录数
          String [][] tableRecord=pageBean.getTableRecord();
          tableRecord = new String[rowNumber][columnCount];
          rs.beforeFirst();
          int i=0;
          while(rs.next()){
            for(int k=0;k<columnCount;k++) 
              tableRecord[i][k] = rs.getString(k+1);
              i++; 
          }
          pageBean.setTableRecord(tableRecord); //更新Javabean数据模型
          con.close();
          response.sendRedirect("example7_8_pageShow.jsp");  //重定向
     }
     catch(SQLException e){
          System.out.println(e);
     }  
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
           throws ServletException,IOException{
       doPost(request,response);
   }
   public void fail(HttpServletRequest request,HttpServletResponse response,
                      String backNews) {
        response.setContentType("text/html;charset=GB2312");
        try {
         PrintWriter out=response.getWriter();
         out.println("<html><body>");
         out.println("<h2>"+backNews+"</h2>") ;
         out.println("返回");
         out.println("<a href =example7_8.jsp>输入正确信息</a>");
         out.println("</body></html>");
        }
        catch(IOException exp){} 
  }

}

```



## 常见数据库连接

### 连接Microsoft SQL Server数据库

```java
try { Class.forName("com.microsoft.sqlserver.jdbc.SQLServerDriver");
}
catch(Exception e){
}

try{  String uri=    
          "jdbc:sqlserver://192.168.100.1:1433;DatabaseName=warehouse";
      String user="sa";
      String password="dog123456";
      con=DriverManager.getConnection(uri,user,password);
   }
catch(SQLException e){
      System.out.println(e);
}

```

### 连接Oracle数据库

```java
Class.forName("oracle.jdbc.driver.OracleDriver").newInstance(); 
Connection con=
DriverManager.getConnection( "jdbc:oracle:thin:@主机:端口号:数据库名","用户名","密码");
```

```java
例如：
String user="scott";
String password="tiger";
con = DriverManager.getConnection 
("jdbc:oracle:thin:@192.168.96.1:1521:oracle9i",user,password);
```



### 连接Microsoft Access数据库

```java
Class.forName("sun.jdbc.odbc.JdbcOdbcDriver");

Connection con = DriverManager.getConnection("jdbc:odbc:数据源名字“, "loginName"," password ")

```

> 连接Access数据库shop、查询其中的goods表。

```jsp
<%@ page contentType="text/html;charset=GB2312" %>
<%@ page import="java.sql.*" %>
<HTML><BODY bgcolor=cyan>
 <% Connection con;
    Statement sql; 
    ResultSet rs;
    try{  Class.forName("sun.jdbc.odbc.JdbcOdbcDriver");
    }
    catch(ClassNotFoundException e){
          out.print(e);
    }
    try { con=DriverManager.getConnection("jdbc:odbc:myData","","");
          sql=con.createStatement();
          rs=sql.executeQuery("SELECT * FROM goods ");
          out.print("<table border=2>");
          out.print("<tr>");
            out.print("<th width=100>"+"产品号");
            out.print("<th width=100>"+"名称");
            out.print("<th width=50>"+"生产日期");
            out.print("<th width=50>"+"价格");
         out.print("</TR>");
         while(rs.next()){
           out.print("<tr>");
             out.print("<td >"+rs.getString(1)+"</td>"); 
             out.print("<td >"+rs.getString(2)+"</td>");
             out.print("<td >"+rs.getDate("madeTime")+"</td>"); 
             out.print("<td >"+rs.getFloat("price")+"</td>");
           out.print("</tr>") ; 
         }
         out.print("</table>");
         con.close();
   }
   catch(SQLException e){ 
        out.print(e);
   }
 %>
</BODY></HTML>

```





> 标准化考试
>
>    我们很熟悉标准化考试，就是只需在给出的选择中选出正确的答案。在本节的标准化考试中，用户只能顺序的回答每个随机抽取到的题目，即回答一个题目，然后读取下一个题目后，用户就不能再回到上一个题目（类似新的驾驶员交通理论考试规则）。

> 设计要求
>
> 1.考生可以在输入考号的页面输入考号，单击确认提交键开始考试。
> 2.考生单击确认提交键后，可以在答题页面看到随机抽取到的第1题。
> 3.考生回答一个题目后，可以继续随机抽取下一题目。
> 4.考生在答题页面单击交卷提交键，完成考试，系统将给出考生的分数。

> 数据库设计
>
>  创建一个名字为school的数据库，在数据库中使用test表存放试题。test表的各个字段及意义如下：
> number(int) ：存放题号,
> content(char) ：存放试题内容 ,
> a(char) ：存放试题提供的a选择 ,
> b(char) ：存放试题提供的b选择,
> c(char) ：存放试题提供的c选择,
> d(char) ：存放试题提供的d选择,
> pic(char) ：存放试题示意图的图像文件的名字 ,
> answer(char) ：存放试题的答案
>
> 使用student表存放考生的学号和分数。student表的各个字段及意义如下：
> id(char) ：存放考号,
> score(float) ：存放分数。

> ​     例子10给出设计的有关代码，使用MVC模式设计标准化考试。

> ​      根据例子10中使用的servlet的名字及相关类，Web服务目录ch7的WEB-INF下的web.xml文件需包含如下内容：

```xml
<servlet>
    <servlet-name>readTestServlet</servlet-name>
    <servlet-class>myservlet.control.Example7_10_Servlet</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>readTestServlet</servlet-name>
  <url-pattern>/readTestServlet</url-pattern>
</servlet-mapping>
<servlet>
    <servlet-name>endTestServlet</servlet-name>
    <servlet-class>myservlet.control.Example7_10_End_Servlet</servlet-class>
</servlet>
<servlet-mapping>
  <servlet-name>endTestServlet</servlet-name>
  <url-pattern>/endTestServlet</url-pattern>
</servlet-mapping>

```

> ​    模型（Javabean）
> ​    Javabean模型Example7_10_Bean.java负责存储试题以及考生的学号和考试得分的有关信息，在本例子中Example7_10_Bean创建的Javabean模型的id是testBean，scope取值是session。

```java
package mybean.data;
public class Example7_10_Bean{
   String id ;           //存放考号
   float score;         //存放分数
   String questions;    //存放题目
   int number;         //存放题号
   int textAmount=3 ; //题目数量
   String choiceA,choiceB,choiceC,choiceD;//存放选择
   String image;   //题目的示意图的图像文件名
   String answer;       //存放用户给出的答案
   String correctAnswer; //存放正确答案
   String mess;       //存放提示信息 
   public String getCorrectAnswer() {
      return correctAnswer;
   }
   public void setCorrectAnswer(String s){
      correctAnswer =s;
   }
   public void setId(String s){
      id=s;
   }
   public String getId(){
      return id;
   }
   public void setScore(float s) {
      score = s;
   }
   public float getScore() {
      return score;
   }
   public void setQuestions(String s){
      questions=s;
   }
   public String getQuestions(){
      return questions;
   }
   public void setNumber(int s){
      number=s;
   }
   public int getNumber(){
      return number;
   }
   public void setChoiceA(String s){
      choiceA=s;
   }
   public String getChoiceA(){
      return choiceA;
   }
    public void setChoiceB(String s){
      choiceB=s;
   }
   public String getChoiceB(){
      return choiceB;
   }
    public void setChoiceC(String s){
      choiceC=s;
   }
   public String getChoiceC(){
      return choiceC;
   }
   public void setChoiceD(String s){
      choiceD=s;
   }
   public String getChoiceD(){
      return choiceD;
   }
   public void setImage(String s){
      image=s;
   }
   public String getImage(){
      return image;
   } 
   public void setAnswer(String s){
      answer=s;
   }
   public String getAnswer(){
      return answer;
   } 
   public void setMess(String s){
      mess=s;
   }
   public String getMess(){
      return mess;
   }
   public void setTestAmount(int s){
      textAmount=s;
   }
   public int getTestAmount(){
      return textAmount;
   } 
}

```





> 视图（JSP页面）
>        视图部分由2个JSP页面构成，其中example7_10.jsp页面负责提供输入考号，单击开始考试按钮。
>
> example7_10_examination.jsp显示数据模型testBean中的数据。用户在example7_10_examination.jsp页面阅读试题，并提给出自己的答案，该答案被存放到到testBean中。
>     
>
> 用户在example7_10_examination.jsp页面可以单击下一题目提交给名字是readTestServlet的servlet，
>       
>
> 在example7_10_examination.jsp页面还可以单击交卷提交键结束考试，即请求名字是endServlet的servlet。
>       
>
>  example7_10.jsp和example7_10_examination.jsp的效果如图7.31(a)(b)所示。

```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<jsp:useBean id="testBean" 
     class="mybean.data.Example7_10_Bean" scope="session"/>
<HTML><body bgcolor=#EAFFCF><font size=2>
<jsp:setProperty name="testBean" property="score" value="0"/>
<jsp:setProperty name="testBean" property="number" value="0"/>
<h2> 考题数量是<jsp:getProperty name="testBean" property="testAmount"/>
<form action="readTestServlet?amount=3"  method="post" >
   <br>输入考号<input type=text name="id" value =-1 size=16 >
   <br><input type=submit name="sub" value="开始考试">
</form>
</font></body></HTML> 

```

```jsp
<%@ page contentType="text/html;charset=gb2312" %>
<jsp:useBean id="testBean" 
     class="mybean.data.Example7_10_Bean" scope="session"/>
<HTML><body bgcolor=#DEEFF9><font size=2>
  <br><b> <jsp:getProperty name="testBean" property="questions"/></b>
  <br> <br><jsp:getProperty name="testBean" property="choiceA"/>
  <br> <br><jsp:getProperty name="testBean" property="choiceB"/>
  <br> <br><jsp:getProperty name="testBean" property="choiceC"/>
  <br> <br><jsp:getProperty name="testBean" property="choiceD"/> 
  <% String pic=testBean.getImage();
     if(pic!=null&&pic.length()>=1) { 
  %>  <br> <image src =image/<%=pic%> width=100 height=60></image>
  <% }
  %>   
  <br>
  <% String studentAnswer = request.getParameter("R");  
     if(studentAnswer!=null&&studentAnswer.length()>=1){
         testBean.setAnswer(studentAnswer.trim());
     }
  %>
   <b>   目前分数： <jsp:getProperty name="testBean" property="score"/>,
   消息： <jsp:getProperty name="testBean" property="mess"/><br>
 <form action="" method=post name=form>
   <br>选择:<input type="radio" name="R" value=A>A 
            <input type="radio" name="R" value=B>B
            <input type="radio" name="R" value=C>C
            <input type="radio" name="R" value=D>D
   <br><input type="submit" value="确认(再读取下一题之前，可反复确认)" name="submit">
 </form>
 <b>你目前给出的选择是<%=studentAnswer %>
 <form action="readTestServlet" method=post name=form>
   <br><input type= "hidden" 
        value="<%=testBean.getId()%>" name ="id">
     <br><input type="submit" value="下一题" name="submit">
 </form> 
 <form action="endTestServlet" method=post name=form>
    <input type="submit" value="交卷" name="submit">
 </form> 
</font></body></HTML> 


```







> 控制器（servlet）
>           有2个控制器Example7_10_Sevlet和Example7_10_End_Servlet。
>     Example7_10_Sevlet负责创建名字是readTestServlet的servlet。readTestServlet负责从数据库的test表中读入试题存放到id是testBean的Javabean数据模型中，然后请求example7_10_examation.jsp显示testBean中的数据。另外，readTestServlet还接收用户提交的答案，并与test表中的答案进行比较，给出用户的得分。
>       Example7_10_End_Servlet负责创建名字是endSerlet的servlet，用户单击交卷提交键，该servlet负责将用户的名和分数添加到数据库。

```java
package myservlet.control;
import mybean.data.Example7_10_Bean; //引入Javabean模型
import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.*;
public class Example7_10_Servlet extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response)
               throws ServletException,IOException{
      Example7_10_Bean testBean=null;
      HttpSession session=request.getSession(true);
      try{  testBean=(Example7_10_Bean)session.getAttribute("testBean");
            if(testBean==null){
                testBean=new Example7_10_Bean(); //创建Javabean对象
                session.setAttribute("testBean",testBean);
            }
      }
      catch(Exception exp){
            testBean=new Example7_10_Bean();  //创建Javabean对象
            session.setAttribute("testBean",testBean);
      } 
     try{  Class.forName("com.mysql.jdbc.Driver");
     }
     catch(Exception e){} 
     request.setCharacterEncoding("gb2312");
     String id=request.getParameter("id");
     if(id==null||id.length()==0) {
        notify(request,response,"必须给出学号");
        return;
     }
     testBean.setId(id); 
     int testAmount = testBean.getTestAmount();   //考题数量
     Connection con;
     Statement sql; 
     ResultSet rs;
     try{ 
          String uri="jdbc:mysql://127.0.0.1/school?"+
                      "user=root&password=&characterEncoding=gb2312";
          con=DriverManager.getConnection(uri);
          sql=con.createStatement(ResultSet.TYPE_SCROLL_SENSITIVE,
                                 ResultSet.CONCUR_READ_ONLY);
          rs=sql.executeQuery("SELECT * FROM test");
          rs.last();    
          int recordAmount=rs.getRow();  //得到记录数
          testAmount = Math.min(recordAmount,testAmount);
          LinkedList<Integer> list=(LinkedList<Integer>)session.getAttribute("list");
          if(list==null||list.size()==0){
             list = new LinkedList<Integer>();
             for(int i=1;i<=recordAmount;i++) {
               list.add(i);
             }
             session.setAttribute("list",list); 
          }
          int m= -1;
          int index=-1;
          if(list.size()>=1) {
             m= (int)(Math.random()*list.size());
             index=list.get(m);
             list.remove(m);
             session.setAttribute("list",list); 
             int tihao=testBean.getNumber();
             if(tihao<testAmount) {
                 //首先判断上一题是否正确，给出分数：
                String studentAnswer=testBean.getAnswer();
                if(studentAnswer!=null&&studentAnswer.length()>=1) {
                   if(studentAnswer.equalsIgnoreCase(testBean.getCorrectAnswer())){
                      float score= testBean.getScore();
                      score++;
                     testBean.setScore(score);
                   }
                }
                //随机抽取下一题目：
                tihao++;
                testBean.setNumber(tihao); //题号
                rs.absolute(index); //随机抽取题目
                testBean.setQuestions(rs.getString(1));//题目内容
                testBean.setChoiceA(rs.getString(2));  //题目的选择a
                testBean.setChoiceB(rs.getString(3));  //题目的选择b
                testBean.setChoiceC(rs.getString(4));  //题目的选择c
                testBean.setChoiceD(rs.getString(5));  //题目的选择d
                testBean.setImage(rs.getString(6));  //题目的示意图名称
                testBean.setCorrectAnswer(rs.getString(7).trim());//题目的答案
                testBean.setMess("现在是第"+tihao+"题");
                con.close(); 
            }
            else {
                testBean.setMess("答题结束，单击交卷查看分数");
                String studentAnswer=testBean.getAnswer(); //判断最后一题
                if(studentAnswer!=null&&studentAnswer.length()>=1) {
                   if(studentAnswer.equalsIgnoreCase(testBean.getCorrectAnswer())){
                      float score= testBean.getScore();
                      score++;
                     testBean.setScore(score);
                   }
                }
                testBean.setAnswer(null);
                testBean.setNumber(0);
                testBean.setQuestions(null);
                testBean.setChoiceA(null);  
                testBean.setChoiceB(null);  
                testBean.setChoiceC(null);  
                testBean.setChoiceD(null);  
                testBean.setImage(null); 
            }
          }
          else {
             testBean.setMess("没有抽到题目");
          }
          response.sendRedirect("example7_10_examination.jsp");
     }
     catch(SQLException e){
          notify(request,response,e.toString());
     }  
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
           throws ServletException,IOException{
       doPost(request,response);
   }
   public void notify(HttpServletRequest request,HttpServletResponse response,
                      String backNews) {
        response.setContentType("text/html;charset=GB2312");
        try {
         PrintWriter out=response.getWriter();
         out.println("<html><body>");
         out.println("<h2>"+backNews+"</h2>") ;
         out.println("返回");
         out.println("<a href =example7_10.jsp>返回</a>");
         out.println("</body></html>");
        }
        catch(IOException exp){} 
    }
}

```





```java
package myservlet.control;
import mybean.data.Example7_10_Bean; //引入Javabean模型
import java.io.*;
import java.sql.*;
import javax.servlet.*;
import javax.servlet.http.*;
import java.util.*;
public class Example7_10_End_Servlet extends HttpServlet{
   public void init(ServletConfig config) throws ServletException{
      super.init(config);
   }
   public void doPost(HttpServletRequest request,HttpServletResponse response)
               throws ServletException,IOException{
      Example7_10_Bean testBean=null;
      HttpSession session=request.getSession(true);
      try{  testBean=(Example7_10_Bean)session.getAttribute("testBean");
      }
      catch(Exception exp){
         response.sendRedirect("example7_10.jsp");   
      } 
      try{  Class.forName("com.mysql.jdbc.Driver");
      }
      catch(Exception e){} 
      request.setCharacterEncoding("gb2312"); 
      String id=testBean.getId();
      Connection con;
      Statement sql; 
      String condition = "INSERT INTO student VALUES"+
                          "("+"'"+id+"',"+testBean.getScore()+")";

      try{ 
          String uri="jdbc:mysql://127.0.0.1/school?"+
                      "user=root&password=&characterEncoding=gb2312";
          con=DriverManager.getConnection(uri);
          sql=con.createStatement();
          sql.executeUpdate(condition);
          float score = testBean.getScore();
          notify(request,response,id+"最后得分:"+score);
          session.invalidate();              //销毁用户的session对象
      }
      catch(SQLException exp){}   
   }
   public  void  doGet(HttpServletRequest request,HttpServletResponse response)
           throws ServletException,IOException{
       doPost(request,response);
   }
   public void notify(HttpServletRequest request,HttpServletResponse response,
                      String backNews) {
        response.setContentType("text/html;charset=GB2312");
        try {
         PrintWriter out=response.getWriter();
         out.println("<html><body>");
         out.println("<h2>"+backNews+"</h2>") ;
         out.println("</body></html>");
        }
        catch(IOException exp){} 
    }
}

```





JSP使用JDBC提供的API和数据库进行交互信息。JDBC技术在数据库开发中占有很重要的地位，JDBC操作不同的数据库仅仅是连接方式上的差异而已，使用JDBC的应用程序一旦和数据库建立连接，就可以使用JDBC提供的API操作数据库。
当查询ResultSet对象中的数据时，不可以关闭和数据库的连接。
使用PreparedStatement对象可以提高操作数据库的效率